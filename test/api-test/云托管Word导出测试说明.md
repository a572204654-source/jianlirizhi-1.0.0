# 云托管 Word 导出功能测试

## 📋 功能说明

这是一个完整的云托管环境 Word 导出功能测试脚本，会自动完成以下步骤：

1. ✅ 用户登录认证
2. ✅ 创建测试项目
3. ✅ 创建测试工程
4. ✅ 创建完整字段的监理日志
5. ✅ 调用导出接口生成 Word 文档
6. ✅ 自动清理测试数据

## 🚀 快速开始

### 方法一：使用根目录快捷脚本

```bash
# 1. 安装依赖（首次运行）
cd test/api-test
npm install
cd ../..

# 2. 运行测试
node test-cloudrun-word.js
```

### 方法二：直接运行测试文件

```bash
# 1. 安装依赖（首次运行）
cd test/api-test
npm install

# 2. 运行测试
node test-cloudrun-word-export.js
```

## ⚙️ 配置说明

测试脚本中的配置（默认已配置好）：

```javascript
const CONFIG = {
  // 云托管API地址
  baseURL: 'https://api.yimengpl.com',
  
  // 输出目录
  outputDir: path.join(__dirname, '../../test-output'),
  
  // Token会自动通过登录获取，无需手动配置
  token: ''
}
```

## 📊 测试内容

### 监理日志完整字段测试

脚本会创建包含所有字段的测试数据：

- **基本信息**: 日期、天气、温度、风向、风力
- **人员信息**: 施工人员数量、姓名、监理人员数量、姓名
- **设备信息**: 设备清单、设备状态
- **施工部位**: 施工位置、施工部位
- **施工内容**: 详细的施工内容描述
- **材料进场**: 材料清单、检验情况
- **质量管理**: 质量问题、处理措施、整改状态
- **安全管理**: 安全问题、处理措施、整改状态
- **进度管理**: 进度状态、延误原因、保证措施
- **其他记录**: 来访记录、会议记录、天气影响、其他事项
- **监理意见**: 监理工程师意见
- **审核信息**: 审核人、审核意见、审核日期

## 📁 输出结果

测试成功后，Word 文档会保存在：

```
test-output/监理日志-云托管测试-[时间戳].docx
```

文件命名示例：
- `监理日志-云托管测试-1699200000000.docx`

## ✅ 预期结果

### 成功的测试输出示例

```
============================================================
步骤1：用户登录
============================================================
✅ 登录成功
ℹ️  Token: eyJhbGciOiJIUzI1NiIs...
ℹ️  用户ID: 123

============================================================
步骤2：创建测试项目
============================================================
✅ 项目创建成功
ℹ️  项目ID: 456

============================================================
步骤3：创建测试工程
============================================================
✅ 工程创建成功
ℹ️  工程ID: 789

============================================================
步骤4：创建监理日志（完整字段测试）
============================================================
✅ 监理日志创建成功
ℹ️  日志ID: 101
ℹ️  包含所有字段的完整测试数据

============================================================
步骤5：测试Word导出
============================================================
ℹ️  正在导出日志ID: 101
ℹ️  请求URL: https://api.yimengpl.com/api/supervision-logs/export
ℹ️  响应Content-Type: application/vnd.openxmlformats-officedocument...
✅ Word文档导出成功！
ℹ️  文件路径: C:\...\test-output\监理日志-云托管测试-1699200000000.docx
ℹ️  文件大小: 45.67 KB

============================================================
步骤6：清理测试数据
============================================================
✅ 删除监理日志: 101
✅ 删除工程: 789
✅ 删除项目: 456

============================================================
测试结果汇总
============================================================
✅ 登录认证: 通过
✅ 创建项目: 通过
✅ 创建工程: 通过
✅ 创建日志: 通过
✅ Word导出: 通过
✅ 清理数据: 通过

🎉 Word导出测试成功！
```

## 🔍 验证步骤

测试成功后，请打开生成的 Word 文档，验证：

1. ✅ 文档能正常打开，无损坏
2. ✅ 所有字段都正确显示
3. ✅ 表格格式正确，列宽合适
4. ✅ 中文显示正常，无乱码
5. ✅ 日期格式正确
6. ✅ 多行文本正确换行
7. ✅ 空字段显示为 "无" 或留空

## 🐛 故障排查

### 问题1: 连接失败

```
❌ 登录请求失败: connect ETIMEDOUT
```

**解决方法**:
- 检查网络连接
- 确认云托管服务已启动
- 确认 API 地址正确: `https://api.yimengpl.com`

### 问题2: 依赖缺失

```
Error: Cannot find module 'axios'
```

**解决方法**:
```bash
cd test/api-test
npm install
```

### 问题3: 导出失败返回 JSON

```
❌ 响应不是Word文档格式
错误信息: {"code":500,"message":"导出失败"}
```

**解决方法**:
- 检查服务器日志
- 确认 Word 模板文件存在
- 确认数据库中日志数据完整

### 问题4: Token 失效

```
❌ Word导出失败: 401 Unauthorized
```

**解决方法**:
- 测试脚本会自动登录获取 token
- 如果仍然失败，检查 JWT 配置

## 📝 测试记录

| 测试日期 | 测试人 | 测试结果 | 问题记录 | 备注 |
|---------|--------|---------|---------|------|
| 2024-11-08 | | | | |

## 🔗 相关文档

- [API文档](../../docx/c-api/监理日志导出.md)
- [Word 生成器源码](../../utils/wordGenerator.js)
- [监理日志路由](../../routes/supervision-log.js)

## 📞 技术支持

如遇到问题，请提供：
1. 完整的测试输出日志
2. 生成的 Word 文档（如果有）
3. 服务器错误日志
4. 测试环境信息

---

**最后更新**: 2024-11-08
**版本**: v1.0.0


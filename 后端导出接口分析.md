# åç«¯å¯¼å‡ºæ¥å£åˆ†æ

## ğŸ“‹ å½“å‰æ¥å£ä»£ç 

```javascript
router.get('/:id/export', authenticate, async (req, res) => {
  try {
    const { id } = req.params

    // æŸ¥è¯¢ç›‘ç†æ—¥å¿—è¯¦æƒ…
    const logs = await query(
      `SELECT 
        sl.*,
        p.project_name,
        p.project_code,
        w.work_name,
        w.work_code,
        u.nickname as user_name
       FROM supervision_logs sl
       LEFT JOIN projects p ON sl.project_id = p.id
       LEFT JOIN works w ON sl.work_id = w.id
       LEFT JOIN users u ON sl.user_id = u.id
       WHERE sl.id = ?`,
      [id]
    )

    if (logs.length === 0) {
      return notFound(res, 'ç›‘ç†æ—¥å¿—ä¸å­˜åœ¨')  // â† å¯èƒ½çš„é”™è¯¯1
    }

    const logData = logs[0]

    // æŸ¥è¯¢é™„ä»¶ä¿¡æ¯
    const attachments = await query(
      `SELECT 
        file_name,
        file_type,
        file_size
       FROM attachments
       WHERE related_type = 'log' AND related_id = ?
       ORDER BY created_at ASC`,
      [id]
    )

    // æ·»åŠ é™„ä»¶ä¿¡æ¯åˆ°æ—¥å¿—æ•°æ®
    logData.attachments = attachments

    // å¯¼å…¥Wordç”Ÿæˆå·¥å…·
    const { generateSupervisionLogWord } = require('../utils/wordGenerator')

    // ç”ŸæˆWordæ–‡æ¡£
    const wordBuffer = await generateSupervisionLogWord(logData)  // â† å¯èƒ½çš„é”™è¯¯2

    // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ–‡ä»¶å
    const dateStr = logData.log_date ? 
      new Date(logData.log_date).toISOString().split('T')[0] : 
      new Date().toISOString().split('T')[0]
    
    const fileName = `ç›‘ç†æ—¥å¿—_${dateStr}.docx`

    // è®¾ç½®å“åº”å¤´
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document')
    res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(fileName)}"`)
    res.setHeader('Content-Length', wordBuffer.length)

    // è¿”å›æ–‡ä»¶æµ
    res.send(wordBuffer)

  } catch (error) {
    console.error('å¯¼å‡ºç›‘ç†æ—¥å¿—é”™è¯¯:', error)
    return serverError(res, 'å¯¼å‡ºå¤±è´¥')  // â† å¯èƒ½çš„é”™è¯¯3
  }
})
```

---

## ğŸ” å¯èƒ½çš„é”™è¯¯åŸå› 

### é”™è¯¯1ï¼šç›‘ç†æ—¥å¿—ä¸å­˜åœ¨ (404)

**è§¦å‘æ¡ä»¶**ï¼š
```javascript
if (logs.length === 0) {
  return notFound(res, 'ç›‘ç†æ—¥å¿—ä¸å­˜åœ¨')
}
```

**å¯èƒ½åŸå› **ï¼š
1. ä¼ å…¥çš„æ—¥å¿—IDä¸å­˜åœ¨
2. æ—¥å¿—è¢«åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼Œstatus = 2ï¼‰
3. æ—¥å¿—IDæ ¼å¼é”™è¯¯

**æ’æŸ¥æ–¹æ³•**ï¼š
```sql
-- æ£€æŸ¥æ—¥å¿—æ˜¯å¦å­˜åœ¨
SELECT * FROM supervision_logs WHERE id = ä½ çš„æ—¥å¿—ID;

-- æ£€æŸ¥æ—¥å¿—çŠ¶æ€
SELECT id, user_id, title, status FROM supervision_logs WHERE id = ä½ çš„æ—¥å¿—ID;
```

---

### é”™è¯¯2ï¼šWordç”Ÿæˆå¤±è´¥ (500)

**è§¦å‘æ¡ä»¶**ï¼š
```javascript
const wordBuffer = await generateSupervisionLogWord(logData)
```

**å¯èƒ½åŸå› **ï¼š
1. `docx/template.docx` æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨
2. Wordç”Ÿæˆé€»è¾‘é”™è¯¯
3. æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ
4. æ–‡ä»¶ç³»ç»Ÿæƒé™é—®é¢˜

**æ’æŸ¥æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la docx/template.docx

# æŸ¥çœ‹åç«¯æ—¥å¿—ï¼ˆä¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ï¼‰
pm2 logs
# æˆ–
node app.js
```

---

### é”™è¯¯3ï¼šæ•°æ®åº“æŸ¥è¯¢å¤±è´¥ (500)

**è§¦å‘æ¡ä»¶**ï¼š
- æ•°æ®åº“è¿æ¥å¤±è´¥
- SQLè¯­å¥æ‰§è¡Œå¤±è´¥
- å…³è”è¡¨æ•°æ®å¼‚å¸¸

**å¯èƒ½åŸå› **ï¼š
1. æ•°æ®åº“è¿æ¥æ–­å¼€
2. `projects` è¡¨ç¼ºå¤±
3. `works` è¡¨ç¼ºå¤±
4. `attachments` è¡¨ç¼ºå¤±
5. å¤–é”®æ•°æ®ä¸å®Œæ•´

**æ’æŸ¥æ–¹æ³•**ï¼š
```sql
-- æ£€æŸ¥ç›¸å…³è¡¨æ˜¯å¦å­˜åœ¨
SHOW TABLES LIKE '%supervision%';
SHOW TABLES LIKE '%projects%';
SHOW TABLES LIKE '%works%';
SHOW TABLES LIKE '%attachments%';

-- æ£€æŸ¥æ—¥å¿—çš„å…³è”æ•°æ®
SELECT 
  sl.id,
  sl.title,
  sl.project_id,
  p.project_name,
  sl.work_id,
  w.work_name
FROM supervision_logs sl
LEFT JOIN projects p ON sl.project_id = p.id
LEFT JOIN works w ON sl.work_id = w.id
WHERE sl.id = ä½ çš„æ—¥å¿—ID;
```

---

## âš ï¸ ä»£ç é—®é¢˜

### ç¼ºå°‘æƒé™éªŒè¯

å½“å‰ä»£ç **æ²¡æœ‰æ£€æŸ¥æ—¥å¿—æ˜¯å¦å±äºå½“å‰ç”¨æˆ·**ï¼

**å»ºè®®ä¿®æ”¹**ï¼š

```javascript
router.get('/:id/export', authenticate, async (req, res) => {
  try {
    const { id } = req.params
    const userId = req.userId  // â† æ·»åŠ ç”¨æˆ·ID

    // æŸ¥è¯¢ç›‘ç†æ—¥å¿—è¯¦æƒ…
    const logs = await query(
      `SELECT 
        sl.*,
        p.project_name,
        p.project_code,
        w.work_name,
        w.work_code,
        u.nickname as user_name
       FROM supervision_logs sl
       LEFT JOIN projects p ON sl.project_id = p.id
       LEFT JOIN works w ON sl.work_id = w.id
       LEFT JOIN users u ON sl.user_id = u.id
       WHERE sl.id = ? AND sl.user_id = ?`,  // â† æ·»åŠ ç”¨æˆ·éªŒè¯
      [id, userId]
    )

    if (logs.length === 0) {
      return notFound(res, 'ç›‘ç†æ—¥å¿—ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®')
    }

    // ... å…¶ä½™ä»£ç ä¸å˜
  } catch (error) {
    console.error('å¯¼å‡ºç›‘ç†æ—¥å¿—é”™è¯¯:', error)
    return serverError(res, 'å¯¼å‡ºå¤±è´¥')
  }
})
```

---

## ğŸ”§ æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šä½¿ç”¨å‰ç«¯è°ƒè¯•ç‰ˆä»£ç 

å°† `miniapp-example/è°ƒè¯•ç‰ˆ-Wordå¯¼å‡º.js` å¤åˆ¶åˆ°å°ç¨‹åºï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯ã€‚

### æ­¥éª¤2ï¼šæŸ¥çœ‹åç«¯æ—¥å¿—

```bash
# å¦‚æœä½¿ç”¨ pm2
pm2 logs

# æˆ–ç›´æ¥è¿è¡Œ
node app.js

# åº”è¯¥èƒ½çœ‹åˆ°è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
```

### æ­¥éª¤3ï¼šæ£€æŸ¥æ•°æ®åº“

```sql
-- 1. æ£€æŸ¥æ—¥å¿—æ˜¯å¦å­˜åœ¨
SELECT * FROM supervision_logs WHERE id = ä½ çš„æ—¥å¿—ID;

-- 2. æ£€æŸ¥æ—¥å¿—çš„å®Œæ•´ä¿¡æ¯
SELECT 
  sl.id,
  sl.user_id,
  sl.title,
  sl.status,
  p.id as project_id,
  p.project_name,
  w.id as work_id,
  w.work_name
FROM supervision_logs sl
LEFT JOIN projects p ON sl.project_id = p.id
LEFT JOIN works w ON sl.work_id = w.id
WHERE sl.id = ä½ çš„æ—¥å¿—ID;

-- 3. æ£€æŸ¥é™„ä»¶
SELECT * FROM attachments 
WHERE related_type = 'log' AND related_id = ä½ çš„æ—¥å¿—ID;
```

### æ­¥éª¤4ï¼šæµ‹è¯•Wordç”Ÿæˆ

åœ¨åç«¯ç›´æ¥æµ‹è¯•ï¼š

```javascript
// åœ¨ routes/supervision-log.js ä¸­ä¸´æ—¶æ·»åŠ 
router.get('/test-word-generation', async (req, res) => {
  try {
    const { generateSupervisionLogWord } = require('../utils/wordGenerator')
    
    // ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æµ‹è¯•æ•°æ®
    const testData = {
      log_date: '2024-01-01',
      title: 'æµ‹è¯•æ—¥å¿—',
      weather: 'æ™´',
      temperature: '20â„ƒ',
      project_name: 'æµ‹è¯•é¡¹ç›®',
      work_name: 'æµ‹è¯•å·¥ç¨‹',
      content: 'è¿™æ˜¯æµ‹è¯•å†…å®¹',
      attachments: []
    }
    
    const wordBuffer = await generateSupervisionLogWord(testData)
    
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document')
    res.send(wordBuffer)
    
  } catch (error) {
    console.error('Wordç”Ÿæˆæµ‹è¯•å¤±è´¥:', error)
    res.status(500).json({ error: error.message })
  }
})
```

---

## ğŸ“‹ å¿«é€Ÿæ£€æŸ¥æ¸…å•

- [ ] å‰ç«¯ä½¿ç”¨äº†è°ƒè¯•ç‰ˆä»£ç 
- [ ] æŸ¥çœ‹äº†å‰ç«¯æ§åˆ¶å°çš„è¯¦ç»†é”™è¯¯
- [ ] æŸ¥çœ‹äº†åç«¯æ—¥å¿—
- [ ] ç¡®è®¤æ—¥å¿—IDå­˜åœ¨ä¸”æœ‰æ•ˆ
- [ ] ç¡®è®¤æ—¥å¿—çŠ¶æ€æ­£å¸¸ï¼ˆstatus â‰  2ï¼‰
- [ ] ç¡®è®¤å…³è”è¡¨æ•°æ®å®Œæ•´
- [ ] ç¡®è®¤ Word æ¨¡æ¿æ–‡ä»¶å­˜åœ¨
- [ ] æµ‹è¯•äº† Word ç”ŸæˆåŠŸèƒ½

---

## ğŸ’¡ æœ€å¯èƒ½çš„åŸå› ï¼ˆæŒ‰æ¦‚ç‡æ’åºï¼‰

1. **æ—¥å¿—ä¸å­˜åœ¨** (40%)
   - æ£€æŸ¥ä¼ å…¥çš„IDæ˜¯å¦æ­£ç¡®
   
2. **Wordæ¨¡æ¿ç¼ºå¤±** (30%)
   - æ£€æŸ¥ `docx/template.docx` æ˜¯å¦å­˜åœ¨
   
3. **æ•°æ®åº“å…³è”è¡¨ç¼ºå¤±** (20%)
   - æ£€æŸ¥ projectsã€worksã€attachments è¡¨
   
4. **Wordç”Ÿæˆé€»è¾‘é”™è¯¯** (10%)
   - æŸ¥çœ‹åç«¯æ—¥å¿—çš„è¯¦ç»†é”™è¯¯

---

## ğŸ†˜ ä¸‹ä¸€æ­¥

ä½¿ç”¨å‰ç«¯çš„**è°ƒè¯•ç‰ˆä»£ç **ï¼Œä½ ä¼šç«‹å³çœ‹åˆ°åç«¯è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼

```javascript
// åœ¨å°ç¨‹åºä¸­ä¸´æ—¶ä½¿ç”¨
const { exportWord } = require('../../utils/è°ƒè¯•ç‰ˆ-Wordå¯¼å‡º')
exportWord(logId)

// æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
// ä¼šæ˜¾ç¤ºï¼šâŒ æœåŠ¡å™¨è¿”å›é”™è¯¯: {"code":404,"message":"ç›‘ç†æ—¥å¿—ä¸å­˜åœ¨"}
```

æ‹¿åˆ°å…·ä½“çš„é”™è¯¯ä¿¡æ¯åï¼Œå°±èƒ½ç²¾å‡†å®šä½é—®é¢˜äº†ï¼


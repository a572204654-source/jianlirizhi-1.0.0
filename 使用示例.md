# 云部署API验证工具 - 使用示例

## 🎯 你的云部署地址是什么？

在开始验证之前，请先确认你的云部署地址。例如：
- `https://your-app.cloudbaserun.com`
- `https://your-domain.com`

## 📋 三种验证方式

### 方式1: 交互式验证（最简单）⭐⭐⭐

**适合**: 第一次使用、不熟悉命令行

```bash
# 运行交互式验证
npm run verify-interactive
```

**操作步骤**:
1. 运行命令后，会提示你输入云部署地址
2. 输入你的地址，例如: `https://your-app.com`
3. 按回车键开始验证
4. 脚本会一步步引导你完成所有测试
5. 每个测试后会显示结果和建议

**示例输出**:
```
============================================================
🚀 CloudBase API 交互式验证工具
============================================================

请输入你的云部署地址（例如: https://your-app.com）: https://your-app.com

✅ 将测试地址: https://your-app.com

按回车键开始验证，或输入 q 退出: 

============================================================
第1步: 健康检查 ⭐⭐⭐
============================================================
这是最重要的检查，确认服务是否正常运行。

🧪 测试: 健康检查
📍 URL: https://your-app.com/health
✅ 响应状态: 200
✅ 验证通过: 服务正常运行

按回车键继续...
```

---

### 方式2: 快速验证（最快速）⭐⭐⭐

**适合**: 日常使用、快速检查

```bash
# 方法1: 直接传入URL
node test/quick-verify.js https://your-app.com

# 方法2: 使用环境变量
export API_BASE_URL="https://your-app.com"
npm run verify-quick

# Windows PowerShell
$env:API_BASE_URL="https://your-app.com"
npm run verify-quick
```

**示例输出**:
```
============================================================
🚀 快速API验证
============================================================
📍 测试地址: https://your-app.com

1️⃣  健康检查
✅ 服务健康状态

2️⃣  环境诊断
✅ 环境配置正常

3️⃣  API基础接口
✅ API根路径

4️⃣  天气API
✅ 简单天气查询

5️⃣  业务接口
✅ 项目列表
✅ 工程列表
✅ 监理日志列表

6️⃣  权限保护
✅ 权限保护正常

============================================================
🎉 所有关键接口验证通过！
============================================================
```

---

### 方式3: 完整验证（最全面）⭐⭐

**适合**: 深度测试、发布前验证

```bash
# 设置环境变量
export API_BASE_URL="https://your-app.com"

# 运行完整验证
npm run verify-api
```

**示例输出**:
```
============================================================
🚀 开始API接口验证
============================================================
📍 测试地址: https://your-app.com
⏰ 开始时间: 2024-11-08 10:00:00

============================================================
📦 基础服务测试
============================================================

🧪 测试: 健康检查
✅ 通过
   服务正常运行

🧪 测试: 环境诊断
✅ 通过
   环境配置正常

🧪 测试: API根路径
✅ 通过
   API: CloudBase 监理日志小程序 API

============================================================
🌤️  天气API测试
============================================================

🧪 测试: 简单天气查询
✅ 通过
   天气: 晴

🧪 测试: 详细天气查询
✅ 通过
   温度: 20°C

============================================================
📋 公开接口测试（无需登录）
============================================================

🧪 测试: 用户统计
✅ 通过
   用户数: 10

🧪 测试: 项目列表
✅ 通过
   项目数: 5

🧪 测试: 工程列表
✅ 通过
   工程数: 8

🧪 测试: 监理日志列表
✅ 通过
   日志数: 20

============================================================
📊 测试结果汇总
============================================================
总测试数: 15
✅ 通过: 15
❌ 失败: 0
📈 通过率: 100.00%

============================================================
⏰ 结束时间: 2024-11-08 10:01:00
============================================================
```

---

## 🌐 浏览器验证

如果你不想使用命令行，可以直接在浏览器中打开以下URL：

### 1. 健康检查（最重要！）
```
https://your-app.com/health
```

**期望看到**:
```json
{
  "status": "ok",
  "timestamp": 1699200000000,
  "service": "express-miniapp"
}
```

### 2. 环境诊断
```
https://your-app.com/diagnose
```

**检查要点**:
- `diagnosis.warning` 应该是 `null`
- `database.host` 不应该是 `localhost`
- `diagnosis.isLocalhost` 应该是 `false`

### 3. API信息
```
https://your-app.com/api
```

**期望看到**:
```json
{
  "name": "CloudBase 监理日志小程序 API",
  "version": "1.0.0",
  "modules": {
    "auth": "认证模块",
    "user": "用户模块",
    ...
  }
}
```

### 4. 项目列表
```
https://your-app.com/api/projects?page=1&pageSize=10
```

**期望看到**:
```json
{
  "code": 0,
  "message": "获取项目列表成功",
  "data": {
    "list": [...],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 5
    }
  }
}
```

---

## ❌ 常见问题处理

### 问题1: 健康检查失败

**症状**:
```
❌ 服务健康状态 - 错误: connect ECONNREFUSED
```

**原因**: 服务未启动或URL错误

**解决步骤**:
1. 检查URL是否正确（包括 https:// 前缀）
2. 在云托管平台查看服务状态
3. 查看服务日志是否有错误

---

### 问题2: 环境诊断显示警告

**症状**:
```
❌ 环境配置异常: 数据库地址是本地地址，连接会失败！
```

**原因**: 环境变量配置错误

**解决步骤**:

1. 登录云托管平台
2. 找到环境变量配置页面
3. 设置以下变量:

```bash
NODE_ENV=production
DB_HOST_INTERNAL=你的数据库内网地址（例如: 10.0.0.1）
DB_PORT_INTERNAL=3306
DB_USER=数据库用户名
DB_PASSWORD=数据库密码
DB_NAME=数据库名称
```

4. 重启服务
5. 再次运行验证

---

### 问题3: 天气API失败

**症状**:
```
❌ 简单天气查询 - 错误: Request failed with status code 500
```

**原因**: 和风天气API密钥未配置

**解决步骤**:

1. 访问 https://dev.qweather.com/ 注册账号
2. 创建应用获取API密钥
3. 在云托管平台设置环境变量:

```bash
QWEATHER_KEY=你的和风天气密钥
```

4. 重启服务
5. 再次运行验证

---

### 问题4: 权限保护失效

**症状**:
```
❌ 权限保护失效（未登录可以创建资源）
```

**原因**: 认证中间件未生效

**解决步骤**:

1. 检查 `JWT_SECRET` 环境变量是否设置
2. 查看路由文件是否使用了 `authenticate` 中间件
3. 查看最近的代码提交
4. 参考 `docs/权限修复总结.md`

---

## ✅ 验证成功后的下一步

### 1. 配置小程序域名

在微信公众平台：
1. 登录微信公众平台
2. 进入 开发 → 开发管理 → 开发设置
3. 在"服务器域名"中添加你的云部署地址
4. 保存配置

### 2. 测试小程序登录

1. 打开小程序开发者工具
2. 配置 `config.js` 中的 `apiBaseUrl`
3. 点击"登录"按钮测试
4. 查看Network面板确认请求成功

### 3. 测试完整功能

- ✅ 查看项目列表
- ✅ 创建新项目
- ✅ 添加工程
- ✅ 记录监理日志
- ✅ 上传附件
- ✅ 使用AI助手
- ✅ 导出Word文档

---

## 📚 更多文档

- [快速验证指南](docs/快速验证指南.md) - 快速参考
- [API接口验证指南](docs/API接口验证指南.md) - 详细指南
- [云部署验证工具说明](docs/云部署验证工具说明.md) - 完整说明
- [test/README.md](test/README.md) - 测试工具文档

---

## 💡 小贴士

### 定期验证

建议在以下情况下运行验证：
- ✅ 每次代码部署后
- ✅ 修改环境变量后
- ✅ 数据库迁移后
- ✅ 发现问题时

### 自动化监控

可以设置定时任务自动验证：

```bash
# 每5分钟检查一次
*/5 * * * * cd /path/to/project && node test/quick-verify.js https://your-app.com >> /var/log/api-verify.log 2>&1
```

### CI/CD集成

在GitHub Actions中自动验证：

```yaml
- name: Verify API
  run: node test/quick-verify.js ${{ secrets.API_BASE_URL }}
```

---

## 🎉 总结

现在你已经掌握了三种验证方式：

1. **交互式验证** - 适合新手，有详细引导
2. **快速验证** - 适合日常，10秒完成
3. **完整验证** - 适合深度测试，全面覆盖

选择适合你的方式，开始验证你的云部署API吧！

**祝你部署顺利！** 🚀

---

**最后更新**: 2024-11-08


# å’Œé£å¤©æ°” API é›†æˆè¯´æ˜

## âœ… é›†æˆå®Œæˆæƒ…å†µ

### å·²æˆåŠŸé›†æˆçš„åŠŸèƒ½

1. **JWT è®¤è¯ç³»ç»Ÿ**
   - âœ… Ed25519 å¯†é’¥å¯¹ç”Ÿæˆ
   - âœ… JWT token è‡ªåŠ¨ç”Ÿæˆå’Œç¼“å­˜
   - âœ… Token è‡ªåŠ¨ç»­æœŸæœºåˆ¶

2. **å¯ç”¨çš„å¤©æ°”æ¥å£**ï¼ˆå·²æµ‹è¯•é€šè¿‡ï¼‰
   - âœ… å®æ—¶å¤©æ°” (`GET /api/weather/now`)
   - âœ… é€å¤©é¢„æŠ¥ (`GET /api/weather/daily`)
   - âœ… é€å°æ—¶é¢„æŠ¥ (`GET /api/weather/hourly`)

3. **éœ€è¦æ›´é«˜è®¢é˜…è®¡åˆ’çš„æ¥å£**ï¼ˆè¿”å›403ï¼‰
   - âš ï¸ ç©ºæ°”è´¨é‡ (`GET /api/weather/air`)
   - âš ï¸ å¤©æ°”é¢„è­¦ (`GET /api/weather/warning`)
   - âš ï¸ åŸå¸‚æœç´¢ (éœ€è¦ä¸åŒçš„API endpoint)
   - âš ï¸ ç”Ÿæ´»æŒ‡æ•° (éœ€éªŒè¯)

### é…ç½®ä¿¡æ¯

- **é¡¹ç›®ID**: `2HKR2QW8Q7`
- **å‡­æ®ID**: `CCB5WVJ6F8`
- **è®¤è¯æ–¹å¼**: JWT (Ed25519)
- **ç§é’¥æ–‡ä»¶**: `ed25519-private.pem`ï¼ˆå·²æ·»åŠ åˆ° .gitignoreï¼‰

## ğŸ“ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå·²é…ç½®

`.env` æ–‡ä»¶ä¸­å·²é…ç½®ï¼š

```env
QWEATHER_KEY_ID=CCB5WVJ6F8
QWEATHER_PROJECT_ID=2HKR2QW8Q7
```

### 2. æµ‹è¯•å¤©æ°”æ¥å£

**è·å–å®æ—¶å¤©æ°”**ï¼ˆç»çº¬åº¦æ ¼å¼ï¼‰:

```bash
curl "http://localhost/api/weather/now?location=116.41,39.92"
```

**è·å–7å¤©é¢„æŠ¥**:

```bash
curl "http://localhost/api/weather/daily?location=116.41,39.92&days=7"
```

**è·å–24å°æ—¶é¢„æŠ¥**:

```bash
curl "http://localhost/api/weather/hourly?location=116.41,39.92&hours=24"
```

### 3. å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

```javascript
// è·å–å®æ—¶å¤©æ°”
wx.getLocation({
  type: 'gcj02',
  success: (res) => {
    const location = `${res.longitude},${res.latitude}`
    
    wx.request({
      url: 'https://api.yimengpl.com/api/weather/now',
      data: { location },
      success: (res) => {
        if (res.data.code === 0) {
          const weather = res.data.data.data
          console.log('æ¸©åº¦:', weather.temp + 'Â°C')
          console.log('å¤©æ°”:', weather.text)
          console.log('æ¹¿åº¦:', weather.humidity + '%')
        }
      }
    })
  }
})
```

## ğŸ“Š æ¥å£åŠŸèƒ½å¯¹ç…§è¡¨

| æ¥å£ | è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| å®æ—¶å¤©æ°” | `/api/weather/now` | âœ… å¯ç”¨ | è¿”å›å½“å‰å¤©æ°”çŠ¶å†µ |
| é€å¤©é¢„æŠ¥ | `/api/weather/daily` | âœ… å¯ç”¨ | æ”¯æŒ3/7/10/15/30å¤© |
| é€å°æ—¶é¢„æŠ¥ | `/api/weather/hourly` | âœ… å¯ç”¨ | æ”¯æŒ24/72/168å°æ—¶ |
| ç©ºæ°”è´¨é‡ | `/api/weather/air` | âš ï¸ 403 | éœ€è¦æ›´é«˜è®¢é˜…è®¡åˆ’ |
| å¤©æ°”é¢„è­¦ | `/api/weather/warning` | âš ï¸ 403 | éœ€è¦æ›´é«˜è®¢é˜…è®¡åˆ’ |
| ç”Ÿæ´»æŒ‡æ•° | `/api/weather/indices` | â“ æœªæµ‹è¯• | å¯èƒ½éœ€è¦æ›´é«˜è®¢é˜… |
| ç»¼åˆä¿¡æ¯ | `/api/weather/comprehensive` | âš ï¸ éƒ¨åˆ†å¯ç”¨ | ä»…åŒ…å«åŸºç¡€å¤©æ°”æ•°æ® |

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### JWT Token ç¤ºä¾‹

```
eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCIsImtpZCI6IkNDQjVXVko2RjgifQ
.eyJzdWIiOiIySEtSMlFXOFE3IiwiaWF0IjoxNzYyNTkzNjM0LCJleHAiOjE3NjI1OTcyMzR9
._su4GQCoi13OK6pLsSfG2uVvJQXfFm6SkU0SrRZ-lb1Fj8W_ZDt8PCgpTts4MqDBdsFeIjIUcdHkkl5ysUGgCQ
```

**Header**:
```json
{
  "alg": "EdDSA",
  "typ": "JWT",
  "kid": "CCB5WVJ6F8"
}
```

**Payload**:
```json
{
  "sub": "2HKR2QW8Q7",
  "iat": 1762593634,
  "exp": 1762597234
}
```

### Token ç®¡ç†

- **æœ‰æ•ˆæœŸ**: 1å°æ—¶
- **ç¼“å­˜æœºåˆ¶**: è‡ªåŠ¨ç¼“å­˜ï¼Œè¿‡æœŸå‰5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
- **é”™è¯¯å¤„ç†**: è®¤è¯å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•

## ğŸš€ éƒ¨ç½²åˆ°äº‘æ‰˜ç®¡

### 1. ç¡®ä¿ç§é’¥æ–‡ä»¶å­˜åœ¨

```bash
# æ£€æŸ¥ç§é’¥æ–‡ä»¶
ls -la ed25519-private.pem
```

### 2. ç¯å¢ƒå˜é‡é…ç½®

åœ¨è…¾è®¯äº‘ CloudBase äº‘æ‰˜ç®¡æ§åˆ¶å°é…ç½®ç¯å¢ƒå˜é‡ï¼š

```
QWEATHER_KEY_ID=CCB5WVJ6F8
QWEATHER_PROJECT_ID=2HKR2QW8Q7
```

### 3. ä¸Šä¼ ç§é’¥æ–‡ä»¶

**æ–¹æ³•1ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶**ï¼ˆæ¨èï¼‰

åœ¨äº‘æ‰˜ç®¡æ§åˆ¶å°çš„"é…ç½®ç®¡ç†"ä¸­ä¸Šä¼  `ed25519-private.pem` æ–‡ä»¶

**æ–¹æ³•2ï¼šBase64ç¼–ç **

```bash
# å°†ç§é’¥è½¬ä¸ºbase64
base64 ed25519-private.pem

# åœ¨ä»£ç ä¸­è§£ç 
const privateKeyBase64 = process.env.QWEATHER_PRIVATE_KEY_BASE64
const privateKey = Buffer.from(privateKeyBase64, 'base64').toString('utf8')
```

### 4. æ„å»ºå’Œéƒ¨ç½²

```bash
# æ„å»ºDockeré•œåƒ
docker build -t weather-app .

# æ¨é€åˆ°äº‘æ‰˜ç®¡
# (æŒ‰ç…§äº‘æ‰˜ç®¡æ–‡æ¡£æ“ä½œ)
```

## ğŸ“– API è¿”å›æ•°æ®ç¤ºä¾‹

### å®æ—¶å¤©æ°”å“åº”

```json
{
  "code": 0,
  "message": "è·å–å®æ—¶å¤©æ°”æˆåŠŸ",
  "data": {
    "success": true,
    "data": {
      "obsTime": "2025-11-08T17:00+08:00",
      "temp": "15",
      "feelsLike": "14",
      "icon": "100",
      "text": "æ™´",
      "windDir": "åŒ—é£",
      "windScale": "1",
      "windSpeed": "3",
      "humidity": "45",
      "precip": "0.0",
      "pressure": "1020",
      "vis": "10"
    },
    "updateTime": "2025-11-08T17:00+08:00"
  },
  "timestamp": 1699430400000
}
```

### 7å¤©é¢„æŠ¥å“åº”

```json
{
  "code": 0,
  "message": "è·å–å¤©æ°”é¢„æŠ¥æˆåŠŸ",
  "data": {
    "success": true,
    "data": [
      {
        "fxDate": "2025-11-08",
        "sunrise": "06:48",
        "sunset": "17:12",
        "tempMax": "18",
        "tempMin": "8",
        "textDay": "æ™´",
        "textNight": "æ™´",
        "windDirDay": "åŒ—é£",
        "windScaleDay": "1-2",
        "humidity": "40",
        "precip": "0.0",
        "uvIndex": "5"
      }
    ]
  }
}
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: 403 Forbidden

**åŸå› **: æ¥å£éœ€è¦æ›´é«˜çº§çš„è®¢é˜…è®¡åˆ’

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æ‚¨çš„å’Œé£å¤©æ°”è®¢é˜…è®¡åˆ’
2. å‡çº§åˆ°æ”¯æŒè¯¥æ¥å£çš„è®¡åˆ’
3. æˆ–è€…æš‚æ—¶ä¸ä½¿ç”¨è¿”å›403çš„æ¥å£

### é—®é¢˜2: 401 Unauthorized

**åŸå› **: JWTè®¤è¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ç¯å¢ƒå˜é‡ `QWEATHER_KEY_ID` å’Œ `QWEATHER_PROJECT_ID`
2. ç¡®è®¤ç§é’¥æ–‡ä»¶ `ed25519-private.pem` å­˜åœ¨
3. éªŒè¯å…¬é’¥æ˜¯å¦æ­£ç¡®ä¸Šä¼ åˆ°å’Œé£å¤©æ°”æ§åˆ¶å°

### é—®é¢˜3: ç§é’¥æ–‡ä»¶ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**:

```bash
# é‡æ–°ç”Ÿæˆå¯†é’¥å¯¹
node scripts/generate-ed25519-keys.js

# å°†æ–°çš„å…¬é’¥ä¸Šä¼ åˆ°å’Œé£å¤©æ°”æ§åˆ¶å°
cat ed25519-public.pem
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®ç¼“å­˜

å°ç¨‹åºç«¯ç¼“å­˜å¤©æ°”æ•°æ®ï¼š

```javascript
// ç¼“å­˜å¤©æ°”æ•°æ®30åˆ†é’Ÿ
const CACHE_KEY = 'weather_data'
const CACHE_TIME = 30 * 60 * 1000 // 30åˆ†é’Ÿ

// è·å–å¤©æ°”
function getWeather(location) {
  const cache = wx.getStorageSync(CACHE_KEY)
  const now = Date.now()
  
  // æ£€æŸ¥ç¼“å­˜
  if (cache && cache.timestamp && (now - cache.timestamp < CACHE_TIME)) {
    console.log('ä½¿ç”¨ç¼“å­˜æ•°æ®')
    return Promise.resolve(cache.data)
  }
  
  // è¯·æ±‚æ–°æ•°æ®
  return new Promise((resolve, reject) => {
    wx.request({
      url: 'https://api.yimengpl.com/api/weather/now',
      data: { location },
      success: (res) => {
        if (res.data.code === 0) {
          // ç¼“å­˜æ•°æ®
          wx.setStorageSync(CACHE_KEY, {
            data: res.data,
            timestamp: now
          })
          resolve(res.data)
        } else {
          reject(res.data.message)
        }
      },
      fail: reject
    })
  })
}
```

### 2. è¯·æ±‚ä¼˜åŒ–

- æŒ‰éœ€åŠ è½½ï¼šæ ¹æ®é¡µé¢éœ€è¦é€‰æ‹©åˆé€‚çš„æ¥å£
- æ‰¹é‡è¯·æ±‚ï¼šä½¿ç”¨ `comprehensive` æ¥å£ä¸€æ¬¡è·å–å¤šç§æ•°æ®
- é”™è¯¯å¤„ç†ï¼šæ¥å£å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤æ•°æ®æˆ–ä¸Šæ¬¡ç¼“å­˜çš„æ•°æ®

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å’Œé£å¤©æ°” API æ–‡æ¡£](https://dev.qweather.com/docs/api/)
- [JWT è®¤è¯è¯´æ˜](https://dev.qweather.com/docs/resource/signature-auth/)
- [å®Œæ•´APIæ–‡æ¡£](./å¤©æ°”APIæ–‡æ¡£.md)

## âœ… é›†æˆæ£€æŸ¥æ¸…å•

- [x] ç”Ÿæˆ Ed25519 å¯†é’¥å¯¹
- [x] ä¸Šä¼ å…¬é’¥åˆ°å’Œé£å¤©æ°”æ§åˆ¶å°
- [x] é…ç½®ç¯å¢ƒå˜é‡
- [x] å®ç° JWT ç”Ÿæˆå·¥å…·
- [x] å®ç°å¤©æ°” API å°è£…
- [x] åˆ›å»ºè·¯ç”±æ¥å£
- [x] æµ‹è¯•åŸºç¡€æ¥å£ï¼ˆå®æ—¶å¤©æ°”ã€é¢„æŠ¥ï¼‰
- [ ] å‡çº§è®¢é˜…è®¡åˆ’ï¼ˆå¦‚éœ€ä½¿ç”¨ç©ºæ°”è´¨é‡ã€é¢„è­¦ç­‰é«˜çº§åŠŸèƒ½ï¼‰
- [ ] éƒ¨ç½²åˆ°äº‘æ‰˜ç®¡ç¯å¢ƒ
- [ ] å°ç¨‹åºç«¯é›†æˆæµ‹è¯•

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. å’Œé£å¤©æ°”æ§åˆ¶å°çš„å‡­æ®çŠ¶æ€
2. æœåŠ¡ç«¯æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
3. JWT token æ˜¯å¦æ­£ç¡®ç”Ÿæˆ

---

**åˆ›å»ºæ—¶é—´**: 2025-11-08
**æœ€åæ›´æ–°**: 2025-11-08
**é›†æˆçŠ¶æ€**: âœ… åŸºç¡€åŠŸèƒ½å¯ç”¨


# 和风天气云托管配置指南

## 🎯 配置概述

和风天气使用 JWT (Ed25519) 认证方式，需要配置以下内容：
1. 环境变量（项目ID和凭据ID）
2. 私钥文件（用于签名）

## ✅ 已完成的步骤

### 1. 生成密钥对

已通过脚本生成 Ed25519 密钥对：
- ✅ `ed25519-private.pem` - 私钥（本地保存）
- ✅ `ed25519-public.pem` - 公钥（需上传到控制台）

**公钥内容**：
```
-----BEGIN PUBLIC KEY-----
MCowBQYDK2VwAyEA93IxXaFVgYaxhCmvh0uVV7+PUBiE9kI4tIxrOUj8XNo=
-----END PUBLIC KEY-----
```

**公钥 SHA256**：`37cf2e368b7e15b32a896398191538d89d9452a619adfb59c771edc9b47a1fa6`

### 2. 环境变量配置

需要在云托管配置的环境变量：
- `QWEATHER_PROJECT_ID` = `288AH4E373`
- `QWEATHER_KEY_ID` = `CE5AYF96K5` （监理日志 JWT 凭据）
- `QWEATHER_PRIVATE_KEY` = （私钥内容，见下文）

## 📋 待完成的步骤

### 步骤1：确认公钥已上传（✅ 已完成）

根据你的截图，你已经创建了凭据：
- **项目ID**: `288AH4E373`
- **凭据名称**: "监理日志"
- **凭据ID**: `CE5AYF96K5`

⚠️ **重要检查**：请确认这个凭据使用的公钥是：
```
-----BEGIN PUBLIC KEY-----
MCowBQYDK2VwAyEA93IxXaFVgYaxhCmvh0uVV7+PUBiE9kI4tIxrOUj8XNo=
-----END PUBLIC KEY-----
```

如果不是这个公钥，需要：
1. 删除现有凭据
2. 重新创建凭据，使用上面的公钥

### 步骤2：配置云托管环境变量

有两种方法可以将私钥部署到云托管环境：

#### 方法1：使用环境变量（推荐，✅ 代码已支持）

1. **获取私钥内容**：
   ```bash
   # 运行辅助脚本显示私钥
   node scripts/show-private-key.js
   ```

2. **在云托管控制台添加3个环境变量**：

   **变量1：项目ID**
   ```
   变量名：QWEATHER_PROJECT_ID
   变量值：288AH4E373
   ```

   **变量2：凭据ID**
   ```
   变量名：QWEATHER_KEY_ID
   变量值：CE5AYF96K5
   ```

   **变量3：私钥内容**
   ```
   变量名：QWEATHER_PRIVATE_KEY
   变量值：
   -----BEGIN PRIVATE KEY-----
   MC4CAQAwBQYDK2VwBCIEIHTz0h6b9VninF2+131n0ekKzDRi0NvKRARA7obeqAbm
   -----END PRIVATE KEY-----
   ```

   ⚠️ **重要**：必须包括 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----` 这两行！

3. **保存并重新部署**：配置完成后，重新部署云托管服务

#### 方法2：使用配置文件挂载

在云托管控制台的"配置管理"中：
1. 创建配置文件
2. 文件名：`ed25519-private.pem`
3. 内容：私钥内容
4. 挂载路径：`/app/ed25519-private.pem`

## 🔧 代码说明（✅ 已完成）

`utils/qweather-jwt.js` 已经支持从环境变量读取私钥：

- **云托管环境**：从 `QWEATHER_PRIVATE_KEY` 环境变量读取私钥
- **本地开发环境**：从 `ed25519-private.pem` 文件读取私钥

代码会自动判断环境并选择合适的方式读取私钥，无需手动修改。

## 🧪 测试配置

配置完成后，可以测试天气接口：

```bash
# 测试实时天气
curl "https://你的云托管域名/api/weather/now?location=116.41,39.92"

# 应该返回：
{
  "code": 0,
  "message": "获取实时天气成功",
  "data": {
    "success": true,
    "data": {
      "temp": "15",
      "text": "晴",
      ...
    }
  }
}
```

## 📝 配置检查清单

- [ ] 生成 Ed25519 密钥对 ✅
- [ ] 上传公钥到和风天气控制台
- [ ] 记录凭据ID（kid）
- [ ] 在云托管配置环境变量：
  - [ ] `QWEATHER_PROJECT_ID`
  - [ ] `QWEATHER_KEY_ID`
  - [ ] `QWEATHER_PRIVATE_KEY`（方法1）或挂载配置文件（方法2）
- [ ] 重新部署云托管服务
- [ ] 测试天气接口

## ⚠️ 安全注意事项

1. **私钥安全**：
   - 不要将 `ed25519-private.pem` 提交到 Git 仓库
   - 不要在公开场合分享私钥内容
   - 定期轮换密钥

2. **环境变量**：
   - 云托管的环境变量是加密存储的
   - 不要在日志中打印私钥内容

3. **访问控制**：
   - 限制云托管服务的访问权限
   - 定期检查和风天气控制台的访问日志

## 🔗 相关文档

- [和风天气认证文档](https://dev.qweather.com/docs/configuration/authentication/)
- [和风天气控制台](https://console.qweather.com)
- [项目天气API文档](./天气API文档.md)

## 📞 故障排查

### 问题1：401 Unauthorized

**原因**：JWT 认证失败

**解决方案**：
1. 检查凭据ID（kid）是否正确
2. 检查项目ID（sub）是否正确
3. 确认公钥已正确上传到控制台
4. 验证私钥内容完整（包括 BEGIN 和 END 行）

### 问题2：私钥文件不存在

**原因**：云托管环境找不到私钥文件

**解决方案**：
1. 使用环境变量方式传递私钥（推荐）
2. 或者使用配置文件挂载

### 问题3：签名验证失败

**原因**：公钥和私钥不匹配

**解决方案**：
1. 确认上传到控制台的公钥与本地 `ed25519-public.pem` 一致
2. 使用 SHA256 值验证公钥
3. 如果不匹配，重新生成密钥对并上传

---

**创建时间**: 2025-11-08
**最后更新**: 2025-11-08


# ç›‘ç†æ—¥å¿—Wordå¯¼å‡ºAPIæ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|-----|------|
| **APIåç§°** | ç›‘ç†æ—¥å¿—Wordå¯¼å‡ºæ¥å£ |
| **ç‰ˆæœ¬** | v1.0.0 |
| **æœ€åæ›´æ–°** | 2024-11-08 |
| **ç»´æŠ¤äºº** | åç«¯å›¢é˜Ÿ |
| **æ–‡æ¡£ç±»å‹** | Cç«¯APIæ–‡æ¡£ |

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¥å£ç”¨äºå°†æŒ‡å®šçš„ç›‘ç†æ—¥å¿—æ•°æ®å¯¼å‡ºä¸ºæ ‡å‡†æ ¼å¼çš„Wordæ–‡æ¡£ï¼ˆ.docxæ ¼å¼ï¼‰ã€‚ç”Ÿæˆçš„Wordæ–‡æ¡£ä¸¥æ ¼æŒ‰ç…§ç›‘ç†è¡Œä¸šè§„èŒƒï¼ŒåŒ…å«å°é¢é¡µå’Œå†…å®¹é¡µä¸¤éƒ¨åˆ†ï¼Œæ”¯æŒä¸­æ–‡æ˜¾ç¤ºã€è¡¨æ ¼æ ¼å¼åŒ–ã€å¤šè¡Œæ–‡æœ¬å¤„ç†ç­‰åŠŸèƒ½ã€‚

### åº”ç”¨åœºæ™¯
- ç›‘ç†æ—¥å¿—å½’æ¡£å’Œæ‰“å°
- ç›‘ç†æŠ¥å‘Šæ•´ç†
- é¡¹ç›®æ–‡æ¡£ç®¡ç†
- ç›‘ç†å·¥ä½œæ±‡æŠ¥

---

## ğŸ“¡ æ¥å£è¯¦æƒ…

### åŸºæœ¬ä¿¡æ¯

```
æ–¹æ³•: GET
è·¯å¾„: /api/supervision-logs/:id/export
è®¤è¯: éœ€è¦ JWT Token
```

### è¯·æ±‚å‚æ•°

#### URLå‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-------|------|------|------|
| id | Integer | æ˜¯ | ç›‘ç†æ—¥å¿—ID |

#### è¯·æ±‚å¤´

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| Authorization | String | æ˜¯ | JWT Tokenï¼ˆBeareræ–¹å¼ï¼‰ | `Bearer eyJhbGciOiJIUzI1NiIs...` |
| token | String | å¦ | JWT Tokenï¼ˆå¤‡é€‰æ–¹å¼ï¼‰ | `eyJhbGciOiJIUzI1NiIs...` |

**è¯´æ˜**: ä¼˜å…ˆä½¿ç”¨ `Authorization` å¤´ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ `token` å¤´

#### è¯·æ±‚ç¤ºä¾‹

```javascript
// å°ç¨‹åºç«¯è°ƒç”¨ç¤ºä¾‹
wx.request({
  url: 'https://api.yimengpl.com/api/supervision-logs/123/export',
  method: 'GET',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('token')
  },
  responseType: 'arraybuffer', // é‡è¦ï¼šå¿…é¡»è®¾ç½®ä¸ºarraybuffer
  success: (res) => {
    // ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
    const fs = wx.getFileSystemManager()
    const filePath = `${wx.env.USER_DATA_PATH}/ç›‘ç†æ—¥å¿—_${Date.now()}.docx`
    
    fs.writeFile({
      filePath: filePath,
      data: res.data,
      encoding: 'binary',
      success: () => {
        // æ‰“å¼€æ–‡ä»¶
        wx.openDocument({
          filePath: filePath,
          fileType: 'docx',
          success: () => {
            wx.showToast({ title: 'å¯¼å‡ºæˆåŠŸ', icon: 'success' })
          }
        })
      }
    })
  }
})
```

---

## ğŸ“¤ å“åº”è¯´æ˜

### æˆåŠŸå“åº”

**HTTPçŠ¶æ€ç **: 200

**å“åº”å¤´**:
```
Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document
Content-Disposition: attachment; filename="ç›‘ç†æ—¥å¿—_2024-11-08.docx"
Content-Length: 9856
```

**å“åº”ä½“**: Wordæ–‡æ¡£çš„äºŒè¿›åˆ¶æ•°æ®æµï¼ˆBufferï¼‰

**æ–‡ä»¶å‘½åè§„åˆ™**:
```
ç›‘ç†æ—¥å¿—_{æ—¥å¿—æ—¥æœŸ}.docx
```
ä¾‹å¦‚: `ç›‘ç†æ—¥å¿—_2024-11-08.docx`

### é”™è¯¯å“åº”

**HTTPçŠ¶æ€ç **: æ ¹æ®é”™è¯¯ç±»å‹è¿”å›

**å“åº”æ ¼å¼**:
```json
{
  "code": 404,
  "message": "ç›‘ç†æ—¥å¿—ä¸å­˜åœ¨",
  "data": null,
  "timestamp": 1699200000000
}
```

**é”™è¯¯ç è¯´æ˜**:

| HTTPçŠ¶æ€ç  | code | message | è¯´æ˜ |
|-----------|------|---------|------|
| 401 | 401 | è¯·æä¾›è®¤è¯Token | æœªæä¾›Token |
| 401 | 401 | ç”¨æˆ·ä¸å­˜åœ¨ | Tokenæ— æ•ˆæˆ–ç”¨æˆ·å·²åˆ é™¤ |
| 401 | 401 | è®¤è¯å¤±è´¥ | Tokenè¿‡æœŸæˆ–éªŒè¯å¤±è´¥ |
| 404 | 404 | ç›‘ç†æ—¥å¿—ä¸å­˜åœ¨ | æŒ‡å®šIDçš„æ—¥å¿—ä¸å­˜åœ¨ |
| 500 | 500 | å¯¼å‡ºå¤±è´¥ | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |
| 500 | 500 | å¯¼å‡ºå¤±è´¥: {è¯¦ç»†é”™è¯¯} | å¼€å‘ç¯å¢ƒè¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯ |

---

## ğŸ“„ Wordæ–‡æ¡£æ ¼å¼è¯´æ˜

### æ–‡æ¡£ç»“æ„

ç”Ÿæˆçš„Wordæ–‡æ¡£åŒ…å«ä¸¤é¡µï¼š

#### ç¬¬ä¸€é¡µï¼šå°é¢é¡µ

**1. é¡¶éƒ¨æ ‡é¢˜**
- å·¦å¯¹é½: "é™„å½• 11-5 è¡¨"
- å±…ä¸­: "ç›‘ç†æ—¥å¿—"ï¼ˆåŠ ç²—ï¼‰

**2. é¡¹ç›®ä¿¡æ¯è¡¨æ ¼**

| å­—æ®µ | è¯´æ˜ | æ•°æ®æ¥æº |
|-----|------|---------|
| é¡¹ç›®åç§° | é¡¹ç›®åç§° | `projects.project_name` |
| é¡¹ç›®ç¼–å· | é¡¹ç›®ç¼–å· | `projects.project_code` |
| å•é¡¹å·¥ç¨‹åç§° | å·¥ç¨‹åç§° | `works.work_name` |
| å•é¡¹å·¥ç¨‹ç¼–å· | å·¥ç¨‹ç¼–å· | `works.work_code` |
| å•ä½å·¥ç¨‹åç§° | å•ä½å·¥ç¨‹ | `works.unit_work` |
| å•ä½å·¥ç¨‹ç¼–å· | å·¥ç¨‹ç¼–å· | `works.work_code` |

**3. ç›‘ç†æ—¥å¿—å¤§æ ‡é¢˜**
- å±…ä¸­æ˜¾ç¤ºï¼š"ç›‘ç†æ—¥å¿—"
- å­—å·ï¼š72ï¼ˆ36ptï¼‰
- åŠ ç²—

**4. ç›‘ç†æœºæ„ä¿¡æ¯è¡¨æ ¼**

| å­—æ®µ | è¯´æ˜ | æ•°æ®æ¥æº |
|-----|------|---------|
| é¡¹ç›®ç›‘ç†æœºæ„ | ç›‘ç†æœºæ„åç§° | `projects.organization` |
| æ€»ç›‘ç†å·¥ç¨‹å¸ˆ | æ€»ç›‘å§“å | `projects.chief_engineer` |
| ä¸“ä¸šç›‘ç†å·¥ç¨‹å¸ˆ | å¡«å†™äººå§“å | `users.nickname` |
| ç›‘ç†æ—¥å¿—èµ·æ­¢æ—¶é—´ | æ—¥å¿—æ—¶é—´èŒƒå›´ | `works.start_date` è‡³ `works.end_date` |

#### ç¬¬äºŒé¡µï¼šå†…å®¹é¡µ

**1. é¡µé¢æ ‡é¢˜**
- å±…ä¸­: "ç›‘ç†æ—¥å¿—"ï¼ˆåŠ ç²—ï¼‰

**2. åŸºæœ¬ä¿¡æ¯è¡¨æ ¼**

| å­—æ®µ | è¯´æ˜ | æ•°æ®æ¥æº |
|-----|------|---------|
| å•ä½å·¥ç¨‹åç§° | å·¥ç¨‹åç§° | `works.work_name` |
| å•ä½å·¥ç¨‹ç¼–å· | å·¥ç¨‹ç¼–å· | `works.work_code` |
| æ—¥æœŸ | æ—¥å¿—æ—¥æœŸ | `supervision_logs.log_date` |
| æ°”è±¡ | å¤©æ°”æƒ…å†µ | `supervision_logs.weather` |

**3. å†…å®¹è¡¨æ ¼**

| å­—æ®µ | è¯´æ˜ | æ•°æ®æ¥æº | é«˜åº¦ |
|-----|------|---------|------|
| å·¥ç¨‹åŠ¨æ€ | å·¥ç¨‹æ–½å·¥æƒ…å†µ | `supervision_logs.project_dynamics` | å¤§ï¼ˆ3400ï¼‰ |
| ç›‘ç†å·¥ä½œæƒ…å†µ | ç›‘ç†å·¥ä½œè®°å½• | `supervision_logs.supervision_work` | å¤§ï¼ˆ3400ï¼‰ |
| å®‰å…¨ç›‘ç†å·¥ä½œæƒ…å†µ | å®‰å…¨æ£€æŸ¥è®°å½• | `supervision_logs.safety_work` | å¤§ï¼ˆ3400ï¼‰ |

**4. ç­¾å­—æ è¡¨æ ¼**

| å­—æ®µ | è¯´æ˜ | æ•°æ®æ¥æº | æ ¼å¼ |
|-----|------|---------|------|
| è®°å½•äºº | è®°å½•äººå§“å | `supervision_logs.recorder_name` | å§“åå·¦å¯¹é½ |
| è®°å½•äººæ—¥æœŸ | è®°å½•æ—¥æœŸ | `supervision_logs.recorder_date` | æ—¥æœŸå³å¯¹é½ |
| å®¡æ ¸äºº | å®¡æ ¸äººå§“å | `supervision_logs.reviewer_name` | å§“åå·¦å¯¹é½ |
| å®¡æ ¸äººæ—¥æœŸ | å®¡æ ¸æ—¥æœŸ | `supervision_logs.reviewer_date` | æ—¥æœŸå³å¯¹é½ |

### æ ¼å¼è§„èŒƒ

#### å­—ä½“å’Œå­—å·
- å­—ä½“: å®‹ä½“
- å­—å·: 24ï¼ˆ12ptï¼‰
- æ ‡é¢˜åŠ ç²—

#### é¡µè¾¹è·
- ä¸Šè¾¹è·: 1440 twips (1è‹±å¯¸)
- ä¸‹è¾¹è·: 1440 twips (1è‹±å¯¸)
- å·¦è¾¹è·: 720 twips (0.5è‹±å¯¸)
- å³è¾¹è·: 720 twips (0.5è‹±å¯¸)

#### è¡¨æ ¼æ ·å¼
- è¾¹æ¡†: å•çº¿è¾¹æ¡†ï¼Œé»‘è‰²
- å•å…ƒæ ¼å¯¹é½: å‚ç›´å±…ä¸­
- æ–‡æœ¬å¯¹é½: å±…ä¸­å¯¹é½ï¼ˆå†…å®¹åŒºåŸŸå·¦å¯¹é½ï¼Œå¸¦ç¼©è¿›ï¼‰

#### æ—¥æœŸæ ¼å¼
- æ—¥å¿—æ—¥æœŸ: `YYYYå¹´MMæœˆDDæ—¥` æ ¼å¼ï¼ˆå¦‚: 2024å¹´11æœˆ08æ—¥ï¼‰
- æ—¥æœŸèŒƒå›´: `å¼€å§‹æ—¥æœŸ è‡³ ç»“æŸæ—¥æœŸ`
- ç­¾åæ—¥æœŸ: `YYYYå¹´ Mæœˆ Dæ—¥` æ ¼å¼ï¼ˆå¦‚: 2024å¹´ 11æœˆ 8æ—¥ï¼‰

---

## ğŸ’¾ æ•°æ®åº“æŸ¥è¯¢è¯´æ˜

### æŸ¥è¯¢SQL

```sql
SELECT 
  sl.*,
  p.project_name,
  p.project_code,
  p.organization,
  p.chief_engineer,
  p.start_date as project_start_date,
  p.end_date as project_end_date,
  w.work_name,
  w.work_code,
  w.unit_work,
  u.nickname as user_name
FROM supervision_logs sl
LEFT JOIN projects p ON sl.project_id = p.id
LEFT JOIN works w ON sl.work_id = w.id
LEFT JOIN users u ON sl.user_id = u.id
WHERE sl.id = ?
```

### æ¶‰åŠæ•°æ®è¡¨

| è¡¨å | åˆ«å | ä¸»è¦å­—æ®µ | å…³è”å…³ç³» |
|-----|------|---------|---------|
| supervision_logs | sl | æ—¥å¿—ä¸»ä½“æ•°æ® | ä¸»è¡¨ |
| projects | p | é¡¹ç›®ä¿¡æ¯ | `sl.project_id = p.id` |
| works | w | å·¥ç¨‹ä¿¡æ¯ | `sl.work_id = w.id` |
| users | u | ç”¨æˆ·ä¿¡æ¯ | `sl.user_id = u.id` |

### å­—æ®µæ˜ å°„å…³ç³»

#### supervision_logs è¡¨å­—æ®µ

| æ•°æ®åº“å­—æ®µ | Wordå­—æ®µå | è¯´æ˜ |
|-----------|-----------|------|
| log_date | æ—¥æœŸ | æ—¥å¿—æ—¥æœŸ |
| weather | æ°”è±¡ | å¤©æ°”æƒ…å†µ |
| project_dynamics | å·¥ç¨‹åŠ¨æ€ | æ–½å·¥æƒ…å†µ |
| supervision_work | ç›‘ç†å·¥ä½œæƒ…å†µ | ç›‘ç†è®°å½• |
| safety_work | å®‰å…¨ç›‘ç†å·¥ä½œæƒ…å†µ | å®‰å…¨æ£€æŸ¥ |
| recorder_name | è®°å½•äºº | è®°å½•äººå§“å |
| recorder_date | è®°å½•äººæ—¥æœŸ | è®°å½•æ—¥æœŸ |
| reviewer_name | å®¡æ ¸äºº | å®¡æ ¸äººå§“å |
| reviewer_date | å®¡æ ¸äººæ—¥æœŸ | å®¡æ ¸æ—¥æœŸ |

#### projects è¡¨å­—æ®µ

| æ•°æ®åº“å­—æ®µ | Wordå­—æ®µå | è¯´æ˜ |
|-----------|-----------|------|
| project_name | é¡¹ç›®åç§° | é¡¹ç›®åç§° |
| project_code | é¡¹ç›®ç¼–å· | é¡¹ç›®ç¼–å· |
| organization | é¡¹ç›®ç›‘ç†æœºæ„ | ç›‘ç†æœºæ„ |
| chief_engineer | æ€»ç›‘ç†å·¥ç¨‹å¸ˆ | æ€»ç›‘å§“å |
| start_date | èµ·å§‹æ—¥æœŸ | é¡¹ç›®å¼€å§‹ |
| end_date | ç»“æŸæ—¥æœŸ | é¡¹ç›®ç»“æŸ |

#### works è¡¨å­—æ®µ

| æ•°æ®åº“å­—æ®µ | Wordå­—æ®µå | è¯´æ˜ |
|-----------|-----------|------|
| work_name | å•é¡¹å·¥ç¨‹åç§° | å·¥ç¨‹åç§° |
| work_code | å•é¡¹å·¥ç¨‹ç¼–å· | å·¥ç¨‹ç¼–å· |
| unit_work | å•ä½å·¥ç¨‹åç§° | å•ä½å·¥ç¨‹ |
| start_date | èµ·å§‹æ—¥æœŸ | ç›‘ç†æ—¥å¿—å¼€å§‹æ—¶é—´ |
| end_date | ç»“æŸæ—¥æœŸ | ç›‘ç†æ—¥å¿—ç»“æŸæ—¶é—´ |

#### users è¡¨å­—æ®µ

| æ•°æ®åº“å­—æ®µ | Wordå­—æ®µå | è¯´æ˜ |
|-----------|-----------|------|
| nickname | ä¸“ä¸šç›‘ç†å·¥ç¨‹å¸ˆ | å¡«å†™äººå§“å |

---

## ğŸ”§ æŠ€æœ¯å®ç°è¯´æ˜

### æ ¸å¿ƒä¾èµ–

```javascript
const { 
  Document, 
  Packer, 
  Paragraph, 
  Table, 
  TableCell, 
  TableRow, 
  WidthType, 
  AlignmentType, 
  VerticalAlign, 
  BorderStyle, 
  TextRun, 
  PageBreak 
} = require('docx')
```

### å…³é”®æ¨¡å—

#### 1. è·¯ç”±æ¨¡å—
**æ–‡ä»¶**: `routes/supervision-log.js`

**æ ¸å¿ƒæ–¹æ³•**:
```javascript
router.get('/:id/export', authenticate, async (req, res) => {
  // 1. æŸ¥è¯¢ç›‘ç†æ—¥å¿—è¯¦æƒ…ï¼ˆåŒ…å«å…³è”æ•°æ®ï¼‰
  // 2. è°ƒç”¨Wordç”Ÿæˆå·¥å…·
  // 3. è®¾ç½®å“åº”å¤´
  // 4. è¿”å›Wordæ–‡æ¡£äºŒè¿›åˆ¶æµ
})
```

#### 2. Wordç”Ÿæˆæ¨¡å—
**æ–‡ä»¶**: `utils/wordGenerator.js`

**æ ¸å¿ƒæ–¹æ³•**:
```javascript
async function generateSupervisionLogWord(logData) {
  // 1. åˆ›å»ºDocumentå¯¹è±¡
  // 2. æ„å»ºå°é¢é¡µï¼ˆé¡¹ç›®ä¿¡æ¯è¡¨æ ¼ï¼‰
  // 3. æ·»åŠ åˆ†é¡µç¬¦
  // 4. æ„å»ºå†…å®¹é¡µï¼ˆæ—¥å¿—å†…å®¹è¡¨æ ¼ï¼‰
  // 5. ç”ŸæˆBufferå¹¶è¿”å›
}
```

**è¾…åŠ©æ–¹æ³•**:
- `createCenteredParagraph(text, bold)` - åˆ›å»ºå±…ä¸­æ®µè½
- `createLeftParagraph(text)` - åˆ›å»ºå·¦å¯¹é½æ®µè½
- `createContentParagraph(text)` - åˆ›å»ºå†…å®¹æ®µè½ï¼ˆå¸¦ç¼©è¿›ï¼‰
- `formatDate(date)` - æ ¼å¼åŒ–æ—¥æœŸä¸ºä¸­æ–‡æ ¼å¼
- `formatDateRange(startDate, endDate)` - æ ¼å¼åŒ–æ—¥æœŸèŒƒå›´
- `formatDateForSignature(date)` - æ ¼å¼åŒ–ç­¾åæ—¥æœŸ

#### 3. è®¤è¯ä¸­é—´ä»¶
**æ–‡ä»¶**: `middleware/auth.js`

**æ–¹æ³•**: `authenticate`
- éªŒè¯JWT Token
- æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
- å°†ç”¨æˆ·ä¿¡æ¯æŒ‚è½½åˆ° req å¯¹è±¡

#### 4. å“åº”å·¥å…·
**æ–‡ä»¶**: `utils/response.js`

**æ–¹æ³•**:
- `success(res, data, message)` - æˆåŠŸå“åº”
- `notFound(res, message)` - 404å“åº”
- `serverError(res, message)` - 500å“åº”

#### 5. æ•°æ®åº“å·¥å…·
**æ–‡ä»¶**: `config/database.js`

**æ–¹æ³•**: `query(sql, params)` - æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢

---

## ğŸ¨ æ ·å¼é…ç½®è¯¦æƒ…

### è¡¨æ ¼åˆ—å®½é…ç½®

#### å°é¢é¡µ-é¡¹ç›®ä¿¡æ¯è¡¨æ ¼
```javascript
// ç¬¬1-2è¡Œï¼ˆé¡¹ç›®åç§°ã€é¡¹ç›®ç¼–å·ï¼‰
æ ‡ç­¾åˆ—: 25%
æ•°æ®åˆ—: 75%ï¼ˆåˆå¹¶3åˆ—ï¼‰

// ç¬¬3-4è¡Œï¼ˆå•é¡¹å·¥ç¨‹ã€å•ä½å·¥ç¨‹ï¼‰
åˆ—1: 25%  // æ ‡ç­¾1
åˆ—2: 25%  // æ•°æ®1
åˆ—3: 25%  // æ ‡ç­¾2
åˆ—4: 25%  // æ•°æ®2
```

#### å°é¢é¡µ-ç›‘ç†æœºæ„è¡¨æ ¼
```javascript
// ç¬¬1è¡Œï¼ˆé¡¹ç›®ç›‘ç†æœºæ„ï¼‰
æ ‡ç­¾åˆ—: 25%
æ•°æ®åˆ—: 75%ï¼ˆåˆå¹¶3åˆ—ï¼‰

// ç¬¬2è¡Œï¼ˆæ€»ç›‘ã€ä¸“ä¸šç›‘ç†å·¥ç¨‹å¸ˆï¼‰
åˆ—1: 25%  // æ€»ç›‘æ ‡ç­¾
åˆ—2: 25%  // æ€»ç›‘å§“å
åˆ—3: 25%  // ä¸“ä¸šç›‘ç†æ ‡ç­¾
åˆ—4: 25%  // ä¸“ä¸šç›‘ç†å§“å

// ç¬¬3è¡Œï¼ˆç›‘ç†æ—¥å¿—èµ·æ­¢æ—¶é—´ï¼‰
æ ‡ç­¾åˆ—: 25%
æ•°æ®åˆ—: 75%ï¼ˆåˆå¹¶3åˆ—ï¼‰
```

#### å†…å®¹é¡µ-åŸºæœ¬ä¿¡æ¯è¡¨æ ¼
```javascript
// ç¬¬1è¡Œï¼ˆå•ä½å·¥ç¨‹ä¿¡æ¯ï¼‰
åˆ—1: 16%  // å•ä½å·¥ç¨‹åç§°æ ‡ç­¾
åˆ—2: 34%  // å•ä½å·¥ç¨‹åç§°æ•°æ®
åˆ—3: 16%  // å•ä½å·¥ç¨‹ç¼–å·æ ‡ç­¾
åˆ—4: 34%  // å•ä½å·¥ç¨‹ç¼–å·æ•°æ®

// ç¬¬2-3è¡Œï¼ˆæ—¥æœŸã€æ°”è±¡ï¼‰
åˆ—1: 12%  // æ ‡ç­¾åˆ—
åˆ—2: 88%  // æ•°æ®åˆ—ï¼ˆåˆå¹¶3åˆ—ï¼‰
```

#### å†…å®¹é¡µ-å†…å®¹è¡¨æ ¼
```javascript
// å·¥ç¨‹åŠ¨æ€ã€ç›‘ç†å·¥ä½œã€å®‰å…¨å·¥ä½œ
æ ‡ç­¾åˆ—: 2%   // çºµå‘æ–‡å­—
å†…å®¹åˆ—: 98%  // å†…å®¹åŒºåŸŸ
```

#### å†…å®¹é¡µ-ç­¾å­—æ è¡¨æ ¼
```javascript
// è®°å½•äººã€å®¡æ ¸äºº
åˆ—1: 8%   // è®°å½•äººæ ‡ç­¾
åˆ—2: 34%  // è®°å½•äººç­¾å+æ—¥æœŸ
åˆ—3: 8%   // å®¡æ ¸äººæ ‡ç­¾
åˆ—4: 50%  // å®¡æ ¸äººç­¾å+æ—¥æœŸ

// å†…åµŒè¡¨æ ¼ï¼ˆç­¾å+æ—¥æœŸï¼‰
åˆ—1: 30%  // å§“åï¼ˆå·¦å¯¹é½ï¼‰
åˆ—2: 70%  // æ—¥æœŸï¼ˆå³å¯¹é½ï¼‰
```

### è¡Œé«˜é…ç½®

```javascript
// å¸¸è§„è¡Œ
height: { value: 400, rule: 'atLeast' }  // æœ€å°400 twips

// å¤§æ ‡é¢˜è¡Œ
height: { value: 8000, rule: 'atLeast' } // æœ€å°8000 twips

// å†…å®¹è¡Œ
height: { value: 3400, rule: 'atLeast' } // æœ€å°3400 twips
```

### æ–‡æœ¬ç¼©è¿›å’Œé—´è·

```javascript
// å†…å®¹æ®µè½
indent: {
  left: 400,   // å·¦ç¼©è¿›
  right: 200   // å³ç¼©è¿›
}

spacing: {
  line: 360,    // è¡Œé—´è·
  before: 100,  // æ®µå‰é—´è·
  after: 100    // æ®µåé—´è·
}
```

---

## ğŸ§ª æµ‹è¯•è¯´æ˜

### æµ‹è¯•ç”¨ä¾‹

#### 1. æ­£å¸¸å¯¼å‡ºæµ‹è¯•
```javascript
// æµ‹è¯•æ­¥éª¤
1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·å¹¶ç™»å½•
2. åˆ›å»ºæµ‹è¯•é¡¹ç›®
3. åˆ›å»ºæµ‹è¯•å·¥ç¨‹
4. åˆ›å»ºæµ‹è¯•ç›‘ç†æ—¥å¿—ï¼ˆåŒ…å«å®Œæ•´å­—æ®µï¼‰
5. è°ƒç”¨å¯¼å‡ºæ¥å£
6. éªŒè¯å“åº”å¤´
7. éªŒè¯æ–‡ä»¶å¤§å°
8. æ‰“å¼€Wordæ–‡æ¡£éªŒè¯å†…å®¹

// é¢„æœŸç»“æœ
- HTTPçŠ¶æ€ç : 200
- Content-Typeæ­£ç¡®
- æ–‡ä»¶å¯æ­£å¸¸æ‰“å¼€
- æ‰€æœ‰å­—æ®µæ˜¾ç¤ºæ­£ç¡®
```

#### 2. æ—¥å¿—ä¸å­˜åœ¨æµ‹è¯•
```javascript
// æµ‹è¯•æ­¥éª¤
1. ä½¿ç”¨ä¸å­˜åœ¨çš„æ—¥å¿—IDè°ƒç”¨å¯¼å‡ºæ¥å£

// é¢„æœŸç»“æœ
{
  "code": 404,
  "message": "ç›‘ç†æ—¥å¿—ä¸å­˜åœ¨"
}
```

#### 3. æœªæˆæƒæµ‹è¯•
```javascript
// æµ‹è¯•æ­¥éª¤
1. ä¸æä¾›Tokenè°ƒç”¨å¯¼å‡ºæ¥å£

// é¢„æœŸç»“æœ
{
  "code": 401,
  "message": "è¯·æä¾›è®¤è¯Token"
}
```

#### 4. å­—æ®µç¼ºå¤±æµ‹è¯•
```javascript
// æµ‹è¯•æ­¥éª¤
1. åˆ›å»ºéƒ¨åˆ†å­—æ®µä¸ºç©ºçš„ç›‘ç†æ—¥å¿—
2. è°ƒç”¨å¯¼å‡ºæ¥å£

// é¢„æœŸç»“æœ
- å¯¼å‡ºæˆåŠŸ
- ç¼ºå¤±å­—æ®µæ˜¾ç¤ºä¸ºç©ºç™½
- ä¸å½±å“Wordæ–‡æ¡£ç»“æ„
```

### æµ‹è¯•è„šæœ¬

å‚è€ƒé¡¹ç›®ä¸­çš„æµ‹è¯•è„šæœ¬:
- `test-fixed-fields.js` - å®Œæ•´åŠŸèƒ½æµ‹è¯•
- `test-word-export.js` - Wordå¯¼å‡ºä¸“é¡¹æµ‹è¯•

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å­—æ®µå®Œæ•´æ€§
- ç¡®ä¿ `supervision_logs` è¡¨åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ
- å…³è”è¡¨ï¼ˆprojectsã€worksã€usersï¼‰æ•°æ®å¿…é¡»å­˜åœ¨
- å»ºè®®åœ¨åˆ›å»ºæ—¥å¿—æ—¶è¿›è¡Œå­—æ®µéªŒè¯

### 2. æ—¥æœŸæ ¼å¼
- æ•°æ®åº“æ—¥æœŸå­—æ®µç±»å‹åº”ä¸º DATE æˆ– DATETIME
- åç«¯ä¼šè‡ªåŠ¨æ ¼å¼åŒ–ä¸ºä¸­æ–‡æ—¥æœŸæ ¼å¼
- ç©ºæ—¥æœŸä¼šæ˜¾ç¤ºä¸ºç©ºç™½æˆ–é»˜è®¤æ ¼å¼

### 3. æ–‡æœ¬é•¿åº¦
- é•¿æ–‡æœ¬å†…å®¹ä¼šè‡ªåŠ¨æ¢è¡Œ
- å»ºè®®æ§åˆ¶å•ä¸ªå­—æ®µæ–‡æœ¬é•¿åº¦ï¼ˆä¸è¶…è¿‡5000å­—ç¬¦ï¼‰
- è¿‡é•¿æ–‡æœ¬å¯èƒ½å½±å“Wordæ–‡æ¡£æ€§èƒ½

### 4. ä¸­æ–‡æ”¯æŒ
- ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†ç¡®ä¿ä¸­æ–‡æ­£ç¡®å­˜å‚¨
- Wordç”Ÿæˆä½¿ç”¨å®‹ä½“ç¡®ä¿ä¸­æ–‡æ­£ç¡®æ˜¾ç¤º
- æ–‡ä»¶åä½¿ç”¨ encodeURIComponent ç¼–ç 

### 5. æ€§èƒ½è€ƒè™‘
- Wordç”Ÿæˆä¸ºåŒæ­¥æ“ä½œï¼Œå¤§é‡å¯¼å‡ºå¯èƒ½é˜»å¡çº¿ç¨‹
- å»ºè®®æ·»åŠ å¯¼å‡ºé¢‘ç‡é™åˆ¶ï¼ˆå¦‚1åˆ†é’Ÿå†…æœ€å¤š5æ¬¡ï¼‰
- è€ƒè™‘ä½¿ç”¨é˜Ÿåˆ—å¤„ç†æ‰¹é‡å¯¼å‡º

### 6. é”™è¯¯å¤„ç†
- å¼€å‘ç¯å¢ƒè¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯ä¾¿äºè°ƒè¯•
- ç”Ÿäº§ç¯å¢ƒè¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯ä¿æŠ¤æ•æ„Ÿä¿¡æ¯
- æ‰€æœ‰é”™è¯¯éƒ½ä¼šè®°å½•åˆ°æ§åˆ¶å°æ—¥å¿—

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. æƒé™æ§åˆ¶
```javascript
// å»ºè®®æ·»åŠ æƒé™éªŒè¯
// åªå…è®¸ç”¨æˆ·å¯¼å‡ºè‡ªå·±åˆ›å»ºçš„æ—¥å¿—æˆ–æœ‰æƒé™çš„æ—¥å¿—

const log = logs[0]
if (log.user_id !== req.userId) {
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰é¡¹ç›®æƒé™
  const hasPermission = await checkProjectPermission(req.userId, log.project_id)
  if (!hasPermission) {
    return forbidden(res, 'æ— æƒå¯¼å‡ºæ­¤ç›‘ç†æ—¥å¿—')
  }
}
```

### 2. é¢‘ç‡é™åˆ¶
```javascript
// å»ºè®®ä½¿ç”¨ express-rate-limit
const rateLimit = require('express-rate-limit')

const exportLimiter = rateLimit({
  windowMs: 60 * 1000, // 1åˆ†é’Ÿ
  max: 5, // æœ€å¤š5æ¬¡
  message: 'å¯¼å‡ºæ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•'
})

router.get('/:id/export', authenticate, exportLimiter, async (req, res) => {
  // ...
})
```

### 3. å‚æ•°éªŒè¯
```javascript
// éªŒè¯IDå‚æ•°
const id = parseInt(req.params.id)
if (isNaN(id) || id <= 0) {
  return badRequest(res, 'æ— æ•ˆçš„æ—¥å¿—ID')
}
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å»ºè®®ç›‘æ§çš„æŒ‡æ ‡

1. **å¯¼å‡ºæˆåŠŸç‡**: æˆåŠŸå¯¼å‡ºæ¬¡æ•° / æ€»å¯¼å‡ºæ¬¡æ•°
2. **å¯¼å‡ºè€—æ—¶**: å¹³å‡å¯¼å‡ºæ—¶é—´ã€P95ã€P99
3. **å¯¼å‡ºé¢‘ç‡**: æ¯å°æ—¶/æ¯å¤©å¯¼å‡ºæ¬¡æ•°
4. **æ–‡ä»¶å¤§å°**: å¹³å‡æ–‡ä»¶å¤§å°ã€æœ€å¤§æ–‡ä»¶å¤§å°
5. **é”™è¯¯ç‡**: å„ç±»é”™è¯¯çš„å‘ç”Ÿé¢‘ç‡

### æ—¥å¿—è®°å½•å»ºè®®

```javascript
console.log('ç›‘ç†æ—¥å¿—å¯¼å‡º', {
  userId: req.userId,
  logId: id,
  startTime: Date.now(),
  fileSize: wordBuffer.length,
  duration: Date.now() - startTime
})
```

---

## ğŸ”„ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ | æ›´æ–°äºº |
|------|------|---------|--------|
| v1.0.0 | 2024-11-08 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´å®ç°Wordå¯¼å‡ºåŠŸèƒ½ | åç«¯å›¢é˜Ÿ |
| - | - | æ”¯æŒå°é¢é¡µå’Œå†…å®¹é¡µä¸¤é¡µæ ¼å¼ | - |
| - | - | æ”¯æŒä¸­æ–‡æ—¥æœŸæ ¼å¼åŒ– | - |
| - | - | æ”¯æŒè¡¨æ ¼è‡ªåŠ¨å¸ƒå±€ | - |
| - | - | æ”¯æŒå¤šè¡Œæ–‡æœ¬æ¢è¡Œ | - |

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š

- **æŠ€æœ¯æ”¯æŒ**: åç«¯å¼€å‘å›¢é˜Ÿ
- **æ–‡æ¡£ç»´æŠ¤**: APIæ–‡æ¡£ç»„
- **é—®é¢˜åé¦ˆ**: æäº¤Issueåˆ°é¡¹ç›®ä»“åº“

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç›‘ç†æ—¥å¿—ç®¡ç†APIæ–‡æ¡£](./ç›‘ç†æ—¥å¿—ç®¡ç†APIæ–‡æ¡£.md)
- [é¡¹ç›®ç®¡ç†APIæ–‡æ¡£](./é¡¹ç›®ç®¡ç†APIæ–‡æ¡£.md)
- [å·¥ç¨‹ç®¡ç†APIæ–‡æ¡£](./å·¥ç¨‹ç®¡ç†APIæ–‡æ¡£.md)
- [è®¤è¯å’Œæˆæƒè¯´æ˜](../è®¤è¯å’Œæˆæƒ.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](../../docx/æ•°æ®è¡¨è®¾è®¡.md)

---

**æ–‡æ¡£ç»“æŸ**


# å¾®ä¿¡ä¸€é”®ç™»å½•æµ‹è¯•æŒ‡å—

## ç›®å½•
- [æ¦‚è¿°](#æ¦‚è¿°)
- [æµ‹è¯•å‰å‡†å¤‡](#æµ‹è¯•å‰å‡†å¤‡)
- [æµ‹è¯•æ–¹æ³•](#æµ‹è¯•æ–¹æ³•)
  - [æ–¹æ³•ä¸€ï¼šä½¿ç”¨æµ‹è¯•æ¥å£ï¼ˆæ¨èï¼‰](#æ–¹æ³•ä¸€ä½¿ç”¨æµ‹è¯•æ¥å£æ¨è)
  - [æ–¹æ³•äºŒï¼šä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·](#æ–¹æ³•äºŒä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·)
  - [æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Postman/Apifox](#æ–¹æ³•ä¸‰ä½¿ç”¨-postmanapifox)
- [æµ‹è¯•åœºæ™¯](#æµ‹è¯•åœºæ™¯)
- [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)
- [éªŒè¯æ¸…å•](#éªŒè¯æ¸…å•)

---

## æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›äº†å¾®ä¿¡å°ç¨‹åºä¸€é”®ç™»å½•åŠŸèƒ½ï¼Œæ”¯æŒä»¥ä¸‹ç‰¹æ€§ï¼š
- é€šè¿‡å¾®ä¿¡ `wx.login()` è·å– code
- åç«¯é€šè¿‡ code æ¢å– openid
- è‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·æˆ–è¿”å›å·²æœ‰ç”¨æˆ·ä¿¡æ¯
- è¿”å› JWT token ç”¨äºåç»­è®¤è¯
- æ”¯æŒæµ‹è¯•æ¨¡å¼ï¼Œæ–¹ä¾¿å¼€å‘è°ƒè¯•

---

## æµ‹è¯•å‰å‡†å¤‡

### 1. ç¡®ä¿æœåŠ¡æ­£å¸¸è¿è¡Œ

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•å¯åŠ¨æœåŠ¡
npm start

# æœåŠ¡åº”è¯¥åœ¨ http://localhost è¿è¡Œï¼ˆé»˜è®¤80ç«¯å£ï¼‰
```

### 2. ç¡®ä¿æ•°æ®åº“è¿æ¥æ­£å¸¸

æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®ï¼š

```env
DB_HOST=your-database-host
DB_PORT=3306
DB_USER=your-username
DB_PASSWORD=your-password
DB_NAME=your-database-name
```

### 3. ç¡®ä¿ç”¨æˆ·è¡¨å­˜åœ¨

```sql
-- ç”¨æˆ·è¡¨åº”è¯¥åŒ…å«ä»¥ä¸‹å­—æ®µ
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  openid VARCHAR(255) NOT NULL UNIQUE,
  unionid VARCHAR(255),
  nickname VARCHAR(100),
  avatar VARCHAR(500),
  organization VARCHAR(200),
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

## æµ‹è¯•æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨æµ‹è¯•æ¥å£ï¼ˆæ¨èï¼‰

è¿™æ˜¯æœ€ç®€å•ã€å¿«é€Ÿçš„æµ‹è¯•æ–¹æ³•ï¼Œæ— éœ€çœŸå®çš„å¾®ä¿¡å°ç¨‹åºç¯å¢ƒã€‚

#### æ­¥éª¤ 1ï¼šå‡†å¤‡æµ‹è¯•ç”¨æˆ·

é¦–å…ˆåœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨æˆ·ï¼š

```sql
INSERT INTO users (openid, nickname, avatar, organization) 
VALUES ('test_openid_888888', 'æµ‹è¯•ç”¨æˆ·', '', 'æµ‹è¯•ç»„ç»‡');
```

#### æ­¥éª¤ 2ï¼šä½¿ç”¨ curl æµ‹è¯•

```bash
# ä½¿ç”¨æµ‹è¯•ç™»å½•æ¥å£
curl -X POST http://localhost/api/auth/test-login \
  -H "Content-Type: application/json" \
  -d '{"openid":"test_openid_888888"}'
```

#### æ­¥éª¤ 3ï¼šæ£€æŸ¥å“åº”

æˆåŠŸå“åº”ç¤ºä¾‹ï¼š

```json
{
  "code": 0,
  "message": "æµ‹è¯•ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "isNewUser": false,
    "userInfo": {
      "id": 1,
      "openid": "test_openid_888888",
      "nickname": "æµ‹è¯•ç”¨æˆ·",
      "avatar": "",
      "organization": "æµ‹è¯•ç»„ç»‡"
    }
  },
  "timestamp": 1699200000000
}
```

#### æ­¥éª¤ 4ï¼šéªŒè¯ token æ˜¯å¦æœ‰æ•ˆ

```bash
# ä½¿ç”¨è¿”å›çš„ token è°ƒç”¨éœ€è¦è®¤è¯çš„æ¥å£
curl -X GET http://localhost/api/v1/users/me \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

æˆåŠŸå“åº”è¯´æ˜ç™»å½•å’Œè®¤è¯éƒ½æ­£å¸¸å·¥ä½œã€‚

---

### æ–¹æ³•äºŒï¼šä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·

è¿™æ˜¯æœ€æ¥è¿‘çœŸå®åœºæ™¯çš„æµ‹è¯•æ–¹æ³•ã€‚

#### æ­¥éª¤ 1ï¼šé…ç½®å¾®ä¿¡å°ç¨‹åº

ç¡®ä¿ `.env` æ–‡ä»¶ä¸­é…ç½®äº†æ­£ç¡®çš„å¾®ä¿¡å°ç¨‹åºä¿¡æ¯ï¼š

```env
WECHAT_APPID=your-appid
WECHAT_APPSECRET=your-appsecret
```

#### æ­¥éª¤ 2ï¼šåˆ›å»ºå°ç¨‹åºæµ‹è¯•é¡µé¢

åœ¨å°ç¨‹åºé¡¹ç›®ä¸­åˆ›å»ºç™»å½•æµ‹è¯•é¡µé¢ï¼š

```javascript
// pages/test-login/test-login.js

Page({
  data: {
    loginStatus: 'æœªç™»å½•',
    token: '',
    userInfo: null
  },

  // æµ‹è¯•ç™»å½•
  async testLogin() {
    wx.showLoading({ title: 'ç™»å½•ä¸­...' })

    try {
      // 1. è°ƒç”¨ wx.login è·å– code
      const loginRes = await wx.login()
      console.log('wx.login è¿”å›:', loginRes)

      if (!loginRes.code) {
        throw new Error('è·å– code å¤±è´¥')
      }

      // 2. å‘é€ code åˆ°åç«¯
      const res = await wx.request({
        url: 'http://localhost/api/auth/login',  // æˆ– /api/v1/auth/wechat-login
        method: 'POST',
        data: {
          code: loginRes.code
        }
      })

      console.log('ç™»å½•å“åº”:', res)

      if (res.data.code === 0) {
        // 3. ä¿å­˜ token
        wx.setStorageSync('token', res.data.data.token)
        
        this.setData({
          loginStatus: 'ç™»å½•æˆåŠŸ',
          token: res.data.data.token,
          userInfo: res.data.data.userInfo
        })

        wx.hideLoading()
        wx.showToast({
          title: 'ç™»å½•æˆåŠŸ',
          icon: 'success'
        })
      } else {
        throw new Error(res.data.message || 'ç™»å½•å¤±è´¥')
      }

    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
      wx.hideLoading()
      wx.showToast({
        title: error.message || 'ç™»å½•å¤±è´¥',
        icon: 'none'
      })
    }
  },

  // æµ‹è¯•éœ€è¦è®¤è¯çš„æ¥å£
  async testAuthApi() {
    const token = wx.getStorageSync('token')
    if (!token) {
      wx.showToast({
        title: 'è¯·å…ˆç™»å½•',
        icon: 'none'
      })
      return
    }

    try {
      const res = await wx.request({
        url: 'http://localhost/api/v1/users/me',
        method: 'GET',
        header: {
          'Authorization': `Bearer ${token}`
        }
      })

      console.log('ç”¨æˆ·ä¿¡æ¯:', res.data)

      if (res.data.code === 0) {
        wx.showToast({
          title: 'è®¤è¯æˆåŠŸ',
          icon: 'success'
        })
      }
    } catch (error) {
      console.error('è¯·æ±‚å¤±è´¥:', error)
      wx.showToast({
        title: 'è®¤è¯å¤±è´¥',
        icon: 'none'
      })
    }
  },

  // é€€å‡ºç™»å½•
  logout() {
    wx.removeStorageSync('token')
    this.setData({
      loginStatus: 'æœªç™»å½•',
      token: '',
      userInfo: null
    })
    wx.showToast({
      title: 'å·²é€€å‡º',
      icon: 'success'
    })
  }
})
```

```xml
<!-- pages/test-login/test-login.wxml -->

<view class="container">
  <view class="section">
    <text class="title">ç™»å½•çŠ¶æ€</text>
    <text class="status">{{loginStatus}}</text>
  </view>

  <view class="section" wx:if="{{token}}">
    <text class="title">Token</text>
    <text class="token">{{token}}</text>
  </view>

  <view class="section" wx:if="{{userInfo}}">
    <text class="title">ç”¨æˆ·ä¿¡æ¯</text>
    <text>ID: {{userInfo.id}}</text>
    <text>æ˜µç§°: {{userInfo.nickname}}</text>
    <text>ç»„ç»‡: {{userInfo.organization}}</text>
  </view>

  <view class="buttons">
    <button type="primary" bindtap="testLogin">æµ‹è¯•ç™»å½•</button>
    <button bindtap="testAuthApi">æµ‹è¯•è®¤è¯æ¥å£</button>
    <button bindtap="logout">é€€å‡ºç™»å½•</button>
  </view>
</view>
```

#### æ­¥éª¤ 3ï¼šåœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æµ‹è¯•

1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. æ‰“å¼€æµ‹è¯•é¡µé¢
3. ç‚¹å‡»"æµ‹è¯•ç™»å½•"æŒ‰é’®
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—å’Œé¡µé¢æ˜¾ç¤º
5. ç‚¹å‡»"æµ‹è¯•è®¤è¯æ¥å£"éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ

#### æ­¥éª¤ 4ï¼šæ£€æŸ¥åç«¯æ—¥å¿—

åœ¨æœåŠ¡å™¨æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼š

```bash
# æ­£å¸¸æ—¥å¿—ç¤ºä¾‹
ğŸ§ª [æµ‹è¯•æ¨¡å¼] ä½¿ç”¨æµ‹è¯•ç™»å½•code: test_wechat_code_xxx
# æˆ–
ç™»å½•æˆåŠŸï¼Œç”¨æˆ·ID: 123, openid: oXXXXXXXXXXXXXXX
```

---

### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Postman/Apifox

é€‚åˆå•ç‹¬æµ‹è¯•åç«¯æ¥å£ã€‚

#### æµ‹è¯•çœŸå®å¾®ä¿¡ç™»å½•ï¼ˆéœ€è¦çœŸå® codeï¼‰

**è¯·æ±‚é…ç½®ï¼š**

```
POST http://localhost/api/auth/login
Content-Type: application/json

{
  "code": "çœŸå®çš„å¾®ä¿¡ç™»å½•code"
}
```

**æ³¨æ„ï¼š** å¾®ä¿¡ code åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œä¸”æœ‰æ•ˆæœŸ5åˆ†é’Ÿã€‚

#### æµ‹è¯•å¼€å‘æ¨¡å¼ç™»å½•ï¼ˆä½¿ç”¨æµ‹è¯• codeï¼‰

åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ç‰¹æ®Šæ ¼å¼çš„æµ‹è¯• codeï¼š

**è¯·æ±‚é…ç½®ï¼š**

```
POST http://localhost/api/auth/login
Content-Type: application/json

{
  "code": "test_wechat_code_123456"
}
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "code": 0,
  "message": "ç™»å½•æˆåŠŸï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "isNewUser": true,
    "userInfo": {
      "id": 10,
      "openid": "test_openid_888888",
      "nickname": "ç”¨æˆ·123456",
      "avatar": "",
      "organization": ""
    }
  },
  "timestamp": 1699200000000
}
```

#### éªŒè¯ token

è·å– token åï¼Œæµ‹è¯•éœ€è¦è®¤è¯çš„æ¥å£ï¼š

**è¯·æ±‚é…ç½®ï¼š**

```
GET http://localhost/api/v1/users/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**æˆåŠŸå“åº”ï¼š**

```json
{
  "code": 0,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "id": 10,
    "openid": "test_openid_888888",
    "nickname": "ç”¨æˆ·123456",
    "avatar": "",
    "organization": ""
  },
  "timestamp": 1699200000000
}
```

---

## æµ‹è¯•åœºæ™¯

### 1. æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•

**æµ‹è¯•æ­¥éª¤ï¼š**

1. ä½¿ç”¨ä¸€ä¸ªä»æœªç™»å½•è¿‡çš„ openid æˆ– code
2. è°ƒç”¨ç™»å½•æ¥å£
3. æ£€æŸ¥å“åº”ä¸­ `isNewUser` åº”è¯¥ä¸º `true`
4. æ£€æŸ¥æ•°æ®åº“ï¼Œåº”è¯¥åˆ›å»ºäº†æ–°ç”¨æˆ·è®°å½•

**é¢„æœŸç»“æœï¼š**

```json
{
  "code": 0,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "...",
    "isNewUser": true,
    "userInfo": {
      "id": 123,
      "openid": "oXXXXXXXXXXXX",
      "nickname": "ç”¨æˆ·XXXXXX",
      "avatar": "",
      "organization": ""
    }
  }
}
```

### 2. è€ç”¨æˆ·é‡å¤ç™»å½•

**æµ‹è¯•æ­¥éª¤ï¼š**

1. ä½¿ç”¨å·²ç»ç™»å½•è¿‡çš„ openid æˆ– code
2. è°ƒç”¨ç™»å½•æ¥å£
3. æ£€æŸ¥å“åº”ä¸­ `isNewUser` åº”è¯¥ä¸º `false`
4. æ£€æŸ¥è¿”å›çš„ç”¨æˆ·ä¿¡æ¯ä¸æ•°æ®åº“ä¸­çš„ä¸€è‡´

**é¢„æœŸç»“æœï¼š**

```json
{
  "code": 0,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "...",
    "isNewUser": false,
    "userInfo": {
      "id": 123,
      "openid": "oXXXXXXXXXXXX",
      "nickname": "å·²æœ‰çš„æ˜µç§°",
      "avatar": "å·²æœ‰çš„å¤´åƒURL",
      "organization": "å·²æœ‰çš„ç»„ç»‡"
    }
  }
}
```

### 3. ç¼ºå°‘å¿…éœ€å‚æ•°

**æµ‹è¯•æ­¥éª¤ï¼š**

```bash
curl -X POST http://localhost/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{}'
```

**é¢„æœŸç»“æœï¼š**

```json
{
  "code": 400,
  "message": "ç¼ºå°‘ç™»å½•code",
  "data": null,
  "timestamp": 1699200000000
}
```

### 4. æ— æ•ˆçš„ code

**æµ‹è¯•æ­¥éª¤ï¼š**

```bash
curl -X POST http://localhost/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"code":"invalid_code_12345"}'
```

**é¢„æœŸç»“æœï¼š**

```json
{
  "code": 500,
  "message": "ç™»å½•å¤±è´¥",
  "data": null,
  "timestamp": 1699200000000
}
```

### 5. Token è®¤è¯

**æµ‹è¯•æ­¥éª¤ï¼š**

1. ç™»å½•è·å– token
2. ä½¿ç”¨ token è°ƒç”¨éœ€è¦è®¤è¯çš„æ¥å£
3. ä½¿ç”¨é”™è¯¯çš„ token è°ƒç”¨æ¥å£
4. ä¸ä¼  token è°ƒç”¨æ¥å£

**é¢„æœŸç»“æœï¼š**

- æ­£ç¡® tokenï¼šè¿”å›æ­£å¸¸æ•°æ®
- é”™è¯¯ tokenï¼šè¿”å› 401 æœªæˆæƒ
- æ—  tokenï¼šè¿”å› 401 æœªæˆæƒ

### 6. Token è¿‡æœŸ

**æµ‹è¯•æ­¥éª¤ï¼š**

1. ä½¿ç”¨ä¸€ä¸ªå·²è¿‡æœŸçš„ token
2. è°ƒç”¨éœ€è¦è®¤è¯çš„æ¥å£

**é¢„æœŸç»“æœï¼š**

```json
{
  "code": 401,
  "message": "Tokenå·²è¿‡æœŸ",
  "data": null,
  "timestamp": 1699200000000
}
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šæç¤º"ç¼ºå°‘ç™»å½•code"

**åŸå› ï¼š** è¯·æ±‚ä½“ä¸­æ²¡æœ‰ä¼ é€’ `code` å‚æ•°

**è§£å†³æ–¹æ¡ˆï¼š**

```javascript
// âœ… æ­£ç¡®
wx.request({
  url: 'http://localhost/api/auth/login',
  method: 'POST',
  data: {
    code: 'your_code_here'  // å¿…é¡»ä¼ é€’ code
  }
})

// âŒ é”™è¯¯
wx.request({
  url: 'http://localhost/api/auth/login',
  method: 'POST',
  data: {}  // ç¼ºå°‘ code
})
```

### é—®é¢˜ 2ï¼šæç¤º"invalid code"

**åŸå› ï¼š**

1. code å·²ç»ä½¿ç”¨è¿‡ï¼ˆcode åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼‰
2. code å·²è¿‡æœŸï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
3. code ä¸æ˜¯çœŸå®çš„å¾®ä¿¡ code

**è§£å†³æ–¹æ¡ˆï¼š**

```javascript
// æ¯æ¬¡ç™»å½•æ—¶é‡æ–°è·å– code
const { code } = await wx.login()
// ç«‹å³å‘é€åˆ°åç«¯
await wx.request({
  url: 'http://localhost/api/auth/login',
  method: 'POST',
  data: { code }
})
```

### é—®é¢˜ 3ï¼šå¾®ä¿¡ API è°ƒç”¨å¤±è´¥

**åŸå› ï¼š**

1. WECHAT_APPID æˆ– WECHAT_APPSECRET é…ç½®é”™è¯¯
2. ç½‘ç»œé—®é¢˜ï¼Œæ— æ³•è®¿é—®å¾®ä¿¡æœåŠ¡å™¨
3. å¾®ä¿¡æœåŠ¡å™¨å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆï¼š**

1. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„é…ç½®ï¼š

```env
WECHAT_APPID=wx1234567890abcdef  # æ£€æŸ¥æ˜¯å¦æ­£ç¡®
WECHAT_APPSECRET=abcdef1234567890  # æ£€æŸ¥æ˜¯å¦æ­£ç¡®
```

2. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤å…·ä½“é”™è¯¯ä¿¡æ¯

3. åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨æµ‹è¯• codeï¼š

```javascript
// å¼€å‘ç¯å¢ƒ
const testCode = 'test_wechat_code_' + Date.now()
```

### é—®é¢˜ 4ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**åŸå› ï¼š** æ•°æ®åº“é…ç½®é”™è¯¯æˆ–æ•°æ®åº“æœåŠ¡æœªå¯åŠ¨

**è§£å†³æ–¹æ¡ˆï¼š**

1. æ£€æŸ¥æ•°æ®åº“é…ç½®ï¼š

```env
DB_HOST=localhost  # æˆ–å®é™…çš„æ•°æ®åº“åœ°å€
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=your_database
```

2. æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼š

```bash
node scripts/test-db-connection.js
```

3. ç¡®ä¿æ•°æ®åº“æœåŠ¡æ­£åœ¨è¿è¡Œ

### é—®é¢˜ 5ï¼šToken æ— æ³•éªŒè¯

**åŸå› ï¼š**

1. JWT_SECRET ä¸ä¸€è‡´
2. Token æ ¼å¼é”™è¯¯
3. Token å·²è¿‡æœŸ

**è§£å†³æ–¹æ¡ˆï¼š**

1. æ£€æŸ¥ JWT_SECRET é…ç½®ï¼š

```env
JWT_SECRET=your-secret-key-at-least-32-characters-long
```

2. ç¡®ä¿ token ä¼ é€’æ ¼å¼æ­£ç¡®ï¼š

```javascript
// âœ… æ­£ç¡®æ–¹å¼1ï¼šä½¿ç”¨ Bearer å‰ç¼€
headers: {
  'Authorization': 'Bearer ' + token
}

// âœ… æ­£ç¡®æ–¹å¼2ï¼šä½¿ç”¨ token å­—æ®µ
headers: {
  'token': token
}

// âŒ é”™è¯¯ï¼šç¼ºå°‘ Bearer å‰ç¼€æˆ–ä½¿ç”¨é”™è¯¯çš„å­—æ®µå
headers: {
  'Authorization': token
}
```

3. æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸï¼ˆé»˜è®¤7å¤©æœ‰æ•ˆæœŸï¼‰

### é—®é¢˜ 6ï¼šå¼€å‘ç¯å¢ƒæµ‹è¯• code ä¸ç”Ÿæ•ˆ

**åŸå› ï¼š** NODE_ENV æœªè®¾ç½®ä¸º development

**è§£å†³æ–¹æ¡ˆï¼š**

ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®ï¼š

```env
NODE_ENV=development
```

æˆ–åœ¨å¯åŠ¨æ—¶è®¾ç½®ï¼š

```bash
NODE_ENV=development npm start
```

---

## éªŒè¯æ¸…å•

ä½¿ç”¨ä»¥ä¸‹æ¸…å•ç¡®ä¿ç™»å½•åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼š

### åŸºç¡€åŠŸèƒ½
- [ ] æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] users è¡¨å­˜åœ¨ä¸”ç»“æ„æ­£ç¡®

### ç™»å½•æµç¨‹
- [ ] æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•æˆåŠŸ
- [ ] è€ç”¨æˆ·é‡å¤ç™»å½•æˆåŠŸ
- [ ] è¿”å›æ­£ç¡®çš„ token
- [ ] è¿”å›æ­£ç¡®çš„ç”¨æˆ·ä¿¡æ¯
- [ ] isNewUser æ ‡è¯†æ­£ç¡®

### Token éªŒè¯
- [ ] æ­£ç¡®çš„ token å¯ä»¥é€šè¿‡è®¤è¯
- [ ] é”™è¯¯çš„ token è¿”å› 401
- [ ] æ—  token è¿”å› 401
- [ ] è¿‡æœŸ token è¿”å› 401

### é”™è¯¯å¤„ç†
- [ ] ç¼ºå°‘ code å‚æ•°è¿”å› 400
- [ ] æ— æ•ˆ code è¿”å›é”™è¯¯æç¤º
- [ ] æ•°æ®åº“é”™è¯¯æ­£ç¡®å¤„ç†
- [ ] å¾®ä¿¡ API é”™è¯¯æ­£ç¡®å¤„ç†

### å°ç¨‹åºé›†æˆ
- [ ] wx.login() èƒ½æ­£ç¡®è·å– code
- [ ] code èƒ½æ­£ç¡®å‘é€åˆ°åç«¯
- [ ] token èƒ½æ­£ç¡®ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
- [ ] åç»­è¯·æ±‚èƒ½æ­£ç¡®æºå¸¦ token

### æµ‹è¯•æ¨¡å¼
- [ ] æµ‹è¯•ç™»å½•æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] å¼€å‘ç¯å¢ƒæµ‹è¯• code æ­£å¸¸å·¥ä½œ
- [ ] æµ‹è¯•æ—¥å¿—æ­£ç¡®è¾“å‡º

---

## è‡ªåŠ¨åŒ–æµ‹è¯•

é¡¹ç›®æä¾›äº†è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼Œå¯ä»¥å¿«é€ŸéªŒè¯æ‰€æœ‰åŠŸèƒ½ã€‚

### è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

```bash
# è¿›å…¥æµ‹è¯•ç›®å½•
cd test/api-test

# å®‰è£…ä¾èµ–
npm install

# è¿è¡Œæµ‹è¯•
npm test
```

### ä»…æµ‹è¯•ç™»å½•åŠŸèƒ½

```bash
# ä½¿ç”¨å¿«é€ŸéªŒè¯è„šæœ¬
node test/quick-verify.js
```

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å¼€å§‹æµ‹è¯•: 2024-11-08 10:30:00
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ è®¤è¯APIæµ‹è¯•
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… æµ‹è¯•ç™»å½•
   - token: eyJhbGciOiJIUzI1NiI...
   - userId: 1
   - nickname: æµ‹è¯•ç”¨æˆ·

âœ… é€€å‡ºç™»å½•
   - message: é€€å‡ºæˆåŠŸ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æµ‹è¯•å®Œæˆ: 2024-11-08 10:30:05
æ€»è®¡: 2 | æˆåŠŸ: 2 | å¤±è´¥: 0
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## å°ç»“

å¾®ä¿¡ä¸€é”®ç™»å½•åŠŸèƒ½æµ‹è¯•å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼ï¼š

1. **æµ‹è¯•æ¥å£æ–¹å¼**ï¼ˆæ¨èç”¨äºå¿«é€ŸéªŒè¯ï¼‰
   - ç®€å•å¿«é€Ÿ
   - ä¸éœ€è¦çœŸå®å¾®ä¿¡ç¯å¢ƒ
   - é€‚åˆå¼€å‘è°ƒè¯•

2. **å¾®ä¿¡å¼€å‘è€…å·¥å…·**ï¼ˆæ¨èç”¨äºå®Œæ•´æµ‹è¯•ï¼‰
   - æœ€æ¥è¿‘çœŸå®åœºæ™¯
   - å¯ä»¥æµ‹è¯•å®Œæ•´æµç¨‹
   - é€‚åˆä¸Šçº¿å‰éªŒè¯

3. **API å·¥å…·æ–¹å¼**ï¼ˆæ¨èç”¨äºæ¥å£è°ƒè¯•ï¼‰
   - çµæ´»æ–¹ä¾¿
   - å¯ä»¥æµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µ
   - é€‚åˆæ¥å£å¼€å‘

æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„æµ‹è¯•æ–¹å¼ï¼Œç¡®ä¿ç™»å½•åŠŸèƒ½ç¨³å®šå¯é ã€‚

---

**ç›¸å…³æ–‡æ¡£ï¼š**
- [API æ¥å£æ–‡æ¡£](./c-api/è®¤è¯APIæ–‡æ¡£.md)
- [å°ç¨‹åºé›†æˆç¤ºä¾‹](../miniapp-example/login-example.js)
- [å¿«é€ŸéªŒè¯æŒ‡å—](./å¿«é€ŸéªŒè¯æŒ‡å—.md)


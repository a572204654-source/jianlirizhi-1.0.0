# 天气接口前端对接文档

## 接口概述

天气接口用于获取指定位置和日期的气象信息，支持查询当前日期前后10天的天气数据。该接口主要用于监理日志填写时自动获取对应日期的天气信息。

**基础URL**: `https://your-domain.com/api/v1/weather`

**认证方式**: 需要在请求头中携带JWT Token

---

## 1. 获取指定日期的气象信息

**接口说明**：根据经纬度和日期获取指定位置的气象信息。支持查询当前日期前后10天的天气数据。

**请求地址**：`GET /api/v1/weather/current`

**是否需要认证**：是

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| latitude | Number/String | 是 | 纬度（-90到90） | 39.92 |
| longitude | Number/String | 是 | 经度（-180到180） | 116.41 |
| date | String | 否 | 日期，格式 YYYY-MM-DD。不传则默认为今天 | 2024-01-15 |

### 日期范围说明

- **历史天气**：支持查询当前日期前10天的天气（使用时光机API）
- **今天天气**：不传date参数或传入今天日期，使用实时天气API
- **未来天气**：支持查询当前日期后10天的天气（使用每日预报API）

### 请求示例

#### 示例1：获取今天天气（不传date参数）

```javascript
// 先使用wx.getLocation获取用户位置
wx.getLocation({
  type: 'gcj02',
  success(location) {
    wx.request({
      url: 'https://your-domain.com/api/v1/weather/current',
      method: 'GET',
      header: {
        'Authorization': 'Bearer ' + wx.getStorageSync('token')
      },
      data: {
        latitude: location.latitude,
        longitude: location.longitude
      },
      success(res) {
        if (res.data.code === 0) {
          console.log('今天天气:', res.data.data)
          // 可以直接使用weather字段填写到监理日志中
          const weatherText = res.data.data.weather
        } else {
          console.error('获取天气失败:', res.data.message)
        }
      },
      fail(err) {
        console.error('请求失败:', err)
      }
    })
  },
  fail(err) {
    console.error('获取位置失败:', err)
  }
})
```

#### 示例2：获取指定日期的天气（历史或未来）

```javascript
// 获取10天前的天气（用于填写历史监理日志）
const targetDate = '2024-01-15' // 监理日志的日期

wx.getLocation({
  type: 'gcj02',
  success(location) {
    wx.request({
      url: 'https://your-domain.com/api/v1/weather/current',
      method: 'GET',
      header: {
        'Authorization': 'Bearer ' + wx.getStorageSync('token')
      },
      data: {
        latitude: location.latitude,
        longitude: location.longitude,
        date: targetDate // 传入监理日志的日期
      },
      success(res) {
        if (res.data.code === 0) {
          console.log(`${targetDate}的天气:`, res.data.data)
          // 使用返回的weather字段填写到监理日志中
          const weatherText = res.data.data.weather
        } else {
          console.error('获取天气失败:', res.data.message)
        }
      },
      fail(err) {
        console.error('请求失败:', err)
      }
    })
  }
})
```

#### 示例3：在监理日志填写页面中使用

```javascript
// pages/supervision-log/form.js
Page({
  data: {
    logDate: '', // 监理日志日期
    weather: '', // 天气信息
    latitude: 0,
    longitude: 0
  },

  onLoad(options) {
    // 如果有日志ID，说明是编辑模式，先获取日志信息
    if (options.id) {
      this.loadLogDetail(options.id)
    } else {
      // 新建模式，默认使用今天日期
      const today = new Date()
      const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`
      this.setData({
        logDate: dateStr
      })
    }

    // 获取用户位置
    this.getUserLocation()
  },

  // 获取用户位置
  getUserLocation() {
    wx.getLocation({
      type: 'gcj02',
      success: (res) => {
        this.setData({
          latitude: res.latitude,
          longitude: res.longitude
        })
        // 获取位置后，自动获取天气
        this.loadWeather()
      },
      fail: (err) => {
        console.error('获取位置失败:', err)
        wx.showToast({
          title: '获取位置失败',
          icon: 'none'
        })
      }
    })
  },

  // 日期选择器改变事件
  onDateChange(e) {
    const date = e.detail.value
    this.setData({
      logDate: date
    })
    // 日期改变后，重新获取对应日期的天气
    this.loadWeather()
  },

  // 获取天气信息
  loadWeather() {
    const { latitude, longitude, logDate } = this.data
    
    if (!latitude || !longitude) {
      return
    }

    wx.showLoading({
      title: '获取天气中...'
    })

    wx.request({
      url: 'https://your-domain.com/api/v1/weather/current',
      method: 'GET',
      header: {
        'Authorization': 'Bearer ' + wx.getStorageSync('token')
      },
      data: {
        latitude: latitude,
        longitude: longitude,
        date: logDate // 传入监理日志的日期
      },
      success: (res) => {
        wx.hideLoading()
        if (res.data.code === 0) {
          // 自动填充天气信息到表单
          this.setData({
            weather: res.data.data.weather
          })
          wx.showToast({
            title: '天气获取成功',
            icon: 'success',
            duration: 1500
          })
        } else {
          wx.showToast({
            title: res.data.message || '获取天气失败',
            icon: 'none'
          })
        }
      },
      fail: (err) => {
        wx.hideLoading()
        console.error('获取天气失败:', err)
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        })
      }
    })
  }
})
```

### 响应数据

#### 成功响应

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "weather": "天气 晴 · 气温: 16-24 · 风向: 南风 · 风力: 2",
    "weatherText": "晴",
    "temperature": 20,
    "temperatureMin": 16,
    "temperatureMax": 24,
    "humidity": 65,
    "windDirection": "南风",
    "windScale": "2",
    "updateTime": "2024-01-15T10:00:00+08:00"
  },
  "timestamp": 1699200000000
}
```

#### 错误响应

```json
{
  "code": 400,
  "message": "日期超出范围，仅支持当前日期前后10天",
  "data": null,
  "timestamp": 1699200000000
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| code | Number | 响应码，0表示成功，其他表示错误 | 0 |
| message | String | 响应消息 | "操作成功" |
| data | Object | 响应数据 | - |
| data.weather | String | **完整气象信息字符串（推荐直接使用此字段填写到监理日志）** | "天气 晴 · 气温: 16-24 · 风向: 南风 · 风力: 2" |
| data.weatherText | String | 天气描述（晴、多云、阴、小雨等） | "晴" |
| data.temperature | Number | 当前温度（℃） | 20 |
| data.temperatureMin | Number | 最低温度（℃） | 16 |
| data.temperatureMax | Number | 最高温度（℃） | 24 |
| data.humidity | Number | 湿度（%） | 65 |
| data.windDirection | String | 风向 | "南风" |
| data.windScale | String | 风力等级 | "2" |
| data.updateTime | String | 更新时间 | "2024-01-15T10:00:00+08:00" |
| timestamp | Number | 响应时间戳 | 1699200000000 |

### 错误码说明

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 0 | 成功 | - |
| 400 | 参数错误 | 检查请求参数是否正确 |
| 400 | 经纬度参数不能为空 | 确保传递了latitude和longitude参数 |
| 400 | 经纬度参数格式不正确 | 确保经纬度为有效数字 |
| 400 | 经纬度参数超出有效范围 | 纬度范围：-90到90，经度范围：-180到180 |
| 400 | 日期格式不正确，应为 YYYY-MM-DD | 确保日期格式为YYYY-MM-DD，如：2024-01-15 |
| 400 | 日期超出范围，仅支持当前日期前后10天 | 确保查询日期在当前日期前后10天范围内 |
| 401 | 未授权/Token无效 | 检查Token是否有效，是否需要重新登录 |
| 500 | 服务器错误 | 联系后端开发人员 |
| 500 | 获取历史天气失败 | 可能是和风天气API调用失败，稍后重试 |
| 500 | 获取天气预报失败 | 可能是和风天气API调用失败，稍后重试 |
| 500 | 无法获取位置信息，请检查经纬度是否正确 | 检查经纬度是否正确，或联系后端开发人员 |

---

## 使用场景

### 场景1：填写今天的监理日志

```javascript
// 不传date参数，自动获取今天天气
wx.request({
  url: 'https://your-domain.com/api/v1/weather/current',
  method: 'GET',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('token')
  },
  data: {
    latitude: 39.92,
    longitude: 116.41
    // 不传date，默认今天
  }
})
```

### 场景2：补填历史监理日志

```javascript
// 传入历史日期，获取对应日期的天气
wx.request({
  url: 'https://your-domain.com/api/v1/weather/current',
  method: 'GET',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('token')
  },
  data: {
    latitude: 39.92,
    longitude: 116.41,
    date: '2024-01-10' // 10天前的日期
  }
})
```

### 场景3：填写未来日期的监理日志（计划）

```javascript
// 传入未来日期，获取预报天气
wx.request({
  url: 'https://your-domain.com/api/v1/weather/current',
  method: 'GET',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('token')
  },
  data: {
    latitude: 39.92,
    longitude: 116.41,
    date: '2024-01-25' // 5天后的日期
  }
})
```

---

## 注意事项

### 1. 日期范围限制

- **历史天气**：最多可查询当前日期前10天（不包含今天）
- **未来天气**：最多可查询当前日期后10天
- 超出范围的日期会返回400错误

### 2. 数据来源

- **今天天气**：使用和风天气实时天气API
- **历史天气**：使用和风天气时光机API（历史天气数据）
- **未来天气**：使用和风天气每日预报API

### 3. 数据准确性

- **历史天气**：基于和风天气的历史数据，数据准确可靠
- **未来天气**：基于天气预报，可能存在一定误差
- **今天天气**：实时数据，准确性最高

### 4. 位置信息

- 建议使用 `wx.getLocation` 获取用户当前位置
- 经纬度格式：`gcj02`（国测局坐标系，微信小程序标准）
- 如果用户拒绝授权位置，可以手动输入经纬度或使用项目地址

### 5. 性能优化建议

- 每次请求都会重新获取天气数据，不使用缓存
- 建议在用户选择日期后再调用接口，避免不必要的请求
- 可以在用户输入日期后延迟500ms再请求，避免频繁调用

### 6. 错误处理

- 网络错误：显示"网络错误，请检查网络连接"
- 参数错误：显示具体的错误信息
- 服务器错误：显示"服务异常，请稍后重试"
- Token过期：引导用户重新登录

### 7. 用户体验建议

- 在获取天气时显示加载提示（`wx.showLoading`）
- 获取成功后显示成功提示（`wx.showToast`）
- 获取失败时显示错误提示，但允许用户手动输入天气信息
- 天气信息自动填充到表单，但允许用户手动修改

---

## 完整示例代码

### 小程序页面完整示例

```javascript
// pages/supervision-log/form.js
Page({
  data: {
    logDate: '', // 监理日志日期 YYYY-MM-DD
    weather: '', // 天气信息
    latitude: 0,
    longitude: 0,
    loading: false
  },

  onLoad(options) {
    // 初始化日期（默认为今天）
    const today = new Date()
    const dateStr = this.formatDate(today)
    this.setData({
      logDate: dateStr
    })

    // 获取位置并加载天气
    this.getUserLocation()
  },

  // 格式化日期为 YYYY-MM-DD
  formatDate(date) {
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
  },

  // 获取用户位置
  getUserLocation() {
    wx.getLocation({
      type: 'gcj02',
      success: (res) => {
        this.setData({
          latitude: res.latitude,
          longitude: res.longitude
        })
        // 获取位置后，自动获取天气
        this.loadWeather()
      },
      fail: (err) => {
        console.error('获取位置失败:', err)
        // 如果获取位置失败，仍然可以手动输入天气
        wx.showModal({
          title: '提示',
          content: '获取位置失败，您可以手动输入天气信息',
          showCancel: false
        })
      }
    })
  },

  // 日期选择器改变
  onDateChange(e) {
    const date = e.detail.value
    this.setData({
      logDate: date
    })
    // 日期改变后，重新获取对应日期的天气
    if (this.data.latitude && this.data.longitude) {
      this.loadWeather()
    }
  },

  // 获取天气信息
  loadWeather() {
    const { latitude, longitude, logDate } = this.data
    
    if (!latitude || !longitude || !logDate) {
      return
    }

    // 检查日期范围（前后10天）
    const today = new Date()
    today.setHours(0, 0, 0, 0)
    const targetDate = new Date(logDate)
    targetDate.setHours(0, 0, 0, 0)
    const diffDays = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24))

    if (diffDays < -10 || diffDays > 10) {
      wx.showToast({
        title: '仅支持查询前后10天的天气',
        icon: 'none',
        duration: 2000
      })
      return
    }

    this.setData({ loading: true })

    wx.request({
      url: 'https://your-domain.com/api/v1/weather/current',
      method: 'GET',
      header: {
        'Authorization': 'Bearer ' + wx.getStorageSync('token')
      },
      data: {
        latitude: latitude,
        longitude: longitude,
        date: logDate
      },
      success: (res) => {
        this.setData({ loading: false })
        if (res.data.code === 0) {
          // 自动填充天气信息
          this.setData({
            weather: res.data.data.weather
          })
          wx.showToast({
            title: '天气获取成功',
            icon: 'success',
            duration: 1500
          })
        } else {
          wx.showToast({
            title: res.data.message || '获取天气失败',
            icon: 'none',
            duration: 2000
          })
        }
      },
      fail: (err) => {
        this.setData({ loading: false })
        console.error('获取天气失败:', err)
        wx.showToast({
          title: '网络错误，请稍后重试',
          icon: 'none',
          duration: 2000
        })
      }
    })
  },

  // 手动刷新天气
  onRefreshWeather() {
    this.loadWeather()
  }
})
```

### 对应的WXML文件

```xml
<!-- pages/supervision-log/form.wxml -->
<view class="form-container">
  <!-- 日期选择 -->
  <view class="form-item">
    <text class="label">监理日期</text>
    <picker mode="date" value="{{logDate}}" bindchange="onDateChange">
      <view class="picker">{{logDate || '请选择日期'}}</view>
    </picker>
  </view>

  <!-- 天气信息 -->
  <view class="form-item">
    <text class="label">天气情况</text>
    <view class="weather-row">
      <input 
        class="weather-input" 
        placeholder="点击右侧按钮自动获取" 
        value="{{weather}}"
        bindinput="onWeatherInput"
      />
      <button 
        class="weather-btn" 
        size="mini" 
        bindtap="onRefreshWeather"
        loading="{{loading}}"
      >
        {{loading ? '获取中' : '获取天气'}}
      </button>
    </view>
  </view>
</view>
```

---

## 常见问题

### Q1: 为什么获取不到天气信息？

**A**: 可能的原因：
1. 未授权位置权限 - 检查小程序是否已获取位置权限
2. 经纬度参数错误 - 确保经纬度格式正确
3. 日期超出范围 - 确保日期在当前日期前后10天范围内
4. Token过期 - 检查Token是否有效，可能需要重新登录
5. 网络问题 - 检查网络连接

### Q2: 历史天气数据准确吗？

**A**: 历史天气数据来自和风天气的历史数据库，数据准确可靠。但需要注意的是，历史天气只能查询最近10天（不包含今天）的数据。

### Q3: 未来天气数据准确吗？

**A**: 未来天气数据来自天气预报，可能存在一定误差。建议在填写监理日志时，如果日期是未来日期，可以标注为"预报天气"。

### Q4: 可以缓存天气数据吗？

**A**: 后端接口每次请求都会重新获取天气数据，不使用缓存。前端可以根据需要自行实现缓存逻辑，但建议缓存时间不要超过1小时。

### Q5: 如果用户拒绝位置授权怎么办？

**A**: 如果用户拒绝位置授权，可以：
1. 提示用户手动输入天气信息
2. 使用项目地址的经纬度（如果有的话）
3. 提供位置授权引导，说明需要位置信息才能自动获取天气

---

## 更新日志

### v1.1.0 (2024-01-XX)
- ✅ 新增日期参数支持，可查询指定日期的天气
- ✅ 支持查询历史天气（前10天）
- ✅ 支持查询未来天气（后10天）
- ✅ 优化错误提示信息
- ✅ 移除缓存机制，每次请求都获取最新数据

### v1.0.0 (2024-01-XX)
- ✅ 初始版本，支持获取当前天气

---

## 技术支持

如有问题，请联系后端开发团队或查看项目文档。

**API文档版本**: v1.1.0  
**最后更新**: 2024-01-XX

